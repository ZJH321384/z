<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è€ƒè¯•ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .role-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 40px;
        }
        .role-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .role-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        .role-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        .teacher-icon { color: #1890ff; }
        .student-icon { color: #52c41a; }
        .btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 8px;
        }
        .btn:hover { background: #40a9ff; }
        .btn-success { background: #52c41a; }
        .btn-success:hover { background: #73d13d; }
        .btn-danger { background: #ff4d4f; }
        .btn-danger:hover { background: #ff7875; }
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            margin: 8px 0;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1890ff;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.1);
        }
        
        input:hover, select:hover, textarea:hover {
            border-color: #40a9ff;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
            line-height: 1.6;
        }
        
        textarea::placeholder {
            color: #bfbfbf;
            font-size: 14px;
        }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        .hidden { display: none; }
        .exam-item {
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .status-pending { color: #fa8c16; }
        .status-active { color: #52c41a; }
        .status-ended { color: #8c8c8c; }
        .question-item {
            background: #fafafa;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .option-item {
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            cursor: pointer;
        }
        .option-item:hover { border-color: #1890ff; background: #e6f7ff; }
        .option-item.selected { border-color: #1890ff; background: #1890ff; color: white; }
        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 20px;
            font-weight: bold;
            color: #1890ff;
        }
        .timer.warning { color: #ff4d4f; }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 16px 0;
        }
        .progress-fill {
            height: 100%;
            background: #1890ff;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 24px;
        }
        #question-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        .nav-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #d9d9d9;
            background: white;
            border-radius: 8px;
            cursor: pointer;
        }
        .nav-btn.answered { background: #1890ff; color: white; border-color: #1890ff; }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal:not(.hidden) {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ æ™ºèƒ½è€ƒè¯•ç³»ç»Ÿ</h1>
    </div>

    <div class="container">
        <!-- è§’è‰²é€‰æ‹© -->
        <div id="role-select">
            <div class="role-grid">
                <div class="role-card" onclick="showTeacherLoginPanel()">
                    <div class="role-icon teacher-icon">ğŸ‘¨â€ğŸ«</div>
                    <h2>æ•™å¸ˆç«¯</h2>
                    <p>åˆ›å»ºè€ƒè¯•ã€è®¾ç½®ç§‘ç›®å’Œéš¾åº¦<br>è‡ªåŠ¨ç”Ÿæˆé¢˜ç›®ï¼ŒæŸ¥çœ‹è€ƒè¯•ç»“æœ</p>
                </div>
                <div class="role-card" onclick="showStudentPanel()">
                    <div class="role-icon student-icon">ğŸ‘¨â€ğŸ“</div>
                    <h2>å­¦ç”Ÿç«¯</h2>
                    <p>åŠ å…¥è€ƒè¯•ã€åœ¨çº¿ç­”é¢˜<br>æ”¯æŒå®¢è§‚é¢˜å’Œä¸»è§‚é¢˜å›¾ç‰‡ä¸Šä¼ </p>
                </div>
            </div>
        </div>

        <!-- æ•™å¸ˆç™»å½•/æ³¨å†Œé¢æ¿ -->
        <div id="teacher-login-panel" class="hidden">
            <div class="card" style="max-width: 400px; margin: 0 auto;">
                <h2>ğŸ‘¨â€ğŸ« æ•™å¸ˆç™»å½•</h2>
                <div id="teacher-login-form">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="teacher-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="teacher-password" placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <button class="btn btn-success" onclick="teacherLogin()" style="width: 100%;">ç™»å½•</button>
                    <p style="text-align: center; margin: 16px 0;">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showTeacherRegisterForm()" style="color: #1890ff;">ç«‹å³æ³¨å†Œ</a></p>
                </div>
                <div id="teacher-register-form" style="display: none;">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="teacher-reg-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="teacher-reg-password" placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <div class="form-group">
                        <label>å§“å</label>
                        <input type="text" id="teacher-reg-name" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
                    </div>
                    <div class="form-group">
                        <label>æ•™å­¦ç§‘ç›®</label>
                        <select id="teacher-reg-subject">
                            <option value="">è¯·é€‰æ‹©ç§‘ç›®</option>
                            <option value="è¯­æ–‡">è¯­æ–‡</option>
                            <option value="æ•°å­¦">æ•°å­¦</option>
                            <option value="è‹±è¯­">è‹±è¯­</option>
                            <option value="ç‰©ç†">ç‰©ç†</option>
                            <option value="åŒ–å­¦">åŒ–å­¦</option>
                            <option value="ç”Ÿç‰©">ç”Ÿç‰©</option>
                            <option value="å†å²">å†å²</option>
                            <option value="åœ°ç†">åœ°ç†</option>
                            <option value="æ”¿æ²»">æ”¿æ²»</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ‰€æ•™ç­çº§ï¼ˆå¯å¤šé€‰ï¼‰</label>
                        <div id="teacher-reg-classes" style="margin-top: 8px;">
                            <div style="margin-bottom: 12px;">
                                <strong style="color: #1890ff;">é«˜ä¸€</strong>
                                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 6px;">
                                    ${[1,2,3,4,5,6,7,8,9,10,11,12].map(i => `
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" value="é«˜ä¸€${i}ç­" style="width: auto; margin-right: 4px;"> ${i}ç­
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <strong style="color: #52c41a;">é«˜äºŒ</strong>
                                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 6px;">
                                    ${[1,2,3,4,5,6,7,8,9,10,11,12].map(i => `
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" value="é«˜äºŒ${i}ç­" style="width: auto; margin-right: 4px;"> ${i}ç­
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <strong style="color: #faad14;">é«˜ä¸‰</strong>
                                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 6px;">
                                    ${[1,2,3,4,5,6,7,8,9,10,11,12].map(i => `
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" value="é«˜ä¸‰${i}ç­" style="width: auto; margin-right: 4px;"> ${i}ç­
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="teacherRegister()" style="width: 100%;">æ³¨å†Œ</button>
                    <p style="text-align: center; margin: 16px 0;">å·²æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showTeacherLoginForm()" style="color: #1890ff;">ç«‹å³ç™»å½•</a></p>
                </div>
                <button class="btn" onclick="showRoleSelect()" style="width: 100%; margin-top: 10px;">è¿”å›</button>
            </div>
        </div>

        <!-- æ•™å¸ˆé¢æ¿ -->
        <div id="teacher-panel" class="hidden">
            <div class="card">
                <h2>æ•™å¸ˆæ§åˆ¶å°</h2>
                <div id="teacher-info" style="margin-bottom: 16px; padding: 12px; background: #f6ffed; border-radius: 8px;">
                    <span id="teacher-name-display"></span> | ç§‘ç›®ï¼š<span id="teacher-subject-display" style="color: #1890ff; font-weight: bold;"></span>
                    <div id="teacher-classes-display" style="margin-top: 8px; color: #666;"></div>
                    <span id="teacher-task-stats" style="margin-left: 20px; color: #ff4d4f; font-size: 14px;"></span>
                </div>
                <button class="btn" onclick="showCreateExam()">åˆ›å»ºæ–°è€ƒè¯•</button>
                <button class="btn" onclick="showPaperLibrary()">ğŸ“š è¯•å·åº“</button>
                <button class="btn btn-warning" onclick="showTeacherTasks()">ğŸ“ æˆ‘çš„æ‰¹æ”¹ä»»åŠ¡</button>
                <button class="btn" onclick="teacherLogout()">é€€å‡ºç™»å½•</button>
                <button class="btn btn-danger" onclick="clearAllData()" style="margin-left: 20px;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
                <button class="btn btn-success" onclick="showSearchExamModal()" style="margin-left: 20px;">ğŸ” æŸ¥æ‰¾è€ƒè¯•</button>
            </div>
            <div id="exam-list"></div>
        </div>

        <!-- æ•™å¸ˆæ‰¹æ”¹ä»»åŠ¡é¢æ¿ -->
        <div id="teacher-tasks-panel" class="hidden">
            <div class="card">
                <h2>ğŸ“ æˆ‘çš„æ‰¹æ”¹ä»»åŠ¡</h2>
                <div id="teacher-task-filter" style="margin-bottom: 16px;">
                    <button class="btn" onclick="loadTeacherTasks('pending')" id="btn-pending-tasks">å¾…æ‰¹æ”¹</button>
                    <button class="btn" onclick="loadTeacherTasks('graded')" id="btn-graded-tasks">å·²æ‰¹æ”¹</button>
                </div>
                <button class="btn" onclick="showTeacherPanel()">è¿”å›</button>
            </div>
            <div id="teacher-tasks-list"></div>
        </div>

        <!-- è¯•å·åº“ -->
        <div id="paper-library" class="hidden">
            <div class="card">
                <h2>ğŸ“š è¯•å·åº“</h2>
                <button class="btn" onclick="showTeacherPanel()">è¿”å›</button>
                <button class="btn" onclick="loadPaperStats()">åˆ·æ–°ç»Ÿè®¡</button>
                <button class="btn btn-success" onclick="showAddPaperPanel()">â• æ‰‹åŠ¨æ·»åŠ è¯•å·</button>
            </div>
            <div id="paper-stats" style="margin-bottom: 20px;"></div>
            <div id="paper-list"></div>
        </div>

        <!-- æ‰‹åŠ¨æ·»åŠ è¯•å·é¢æ¿ -->
        <div id="add-paper-panel" class="hidden">
            <div class="card">
                <h2>â• æ‰‹åŠ¨æ·»åŠ è¯•å·</h2>
                <div class="form-group">
                    <label>è¯•å·æ ‡é¢˜</label>
                    <input type="text" id="paper-title" placeholder="ä¾‹å¦‚ï¼š2024å¹´é«˜è€ƒæ•°å­¦çœŸé¢˜">
                </div>
                <div class="form-group">
                    <label>è€ƒè¯•ç±»å‹</label>
                    <select id="paper-exam-type">
                        <option value="é«˜è€ƒ">é«˜è€ƒ</option>
                        <option value="ä¸­è€ƒ">ä¸­è€ƒ</option>
                        <option value="æœŸæœ«è”è€ƒ">æœŸæœ«è”è€ƒ</option>
                        <option value="æœŸä¸­è€ƒè¯•">æœŸä¸­è€ƒè¯•</option>
                        <option value="æ¨¡æ‹Ÿè€ƒè¯•">æ¨¡æ‹Ÿè€ƒè¯•</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>çœä»½/åœ°åŒº</label>
                    <input type="text" id="paper-province" placeholder="ä¾‹å¦‚ï¼šå¹¿ä¸œã€å…¨å›½å·I">
                </div>
                <div class="form-group">
                    <label>ç§‘ç›®</label>
                    <select id="paper-subject">
                        <option value="æ•°å­¦">æ•°å­¦</option>
                        <option value="è¯­æ–‡">è¯­æ–‡</option>
                        <option value="è‹±è¯­">è‹±è¯­</option>
                        <option value="ç‰©ç†">ç‰©ç†</option>
                        <option value="åŒ–å­¦">åŒ–å­¦</option>
                        <option value="ç”Ÿç‰©">ç”Ÿç‰©</option>
                        <option value="å†å²">å†å²</option>
                        <option value="åœ°ç†">åœ°ç†</option>
                        <option value="æ”¿æ²»">æ”¿æ²»</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¹´ä»½</label>
                    <input type="number" id="paper-year" value="2024" min="2010" max="2030">
                </div>
                <div class="form-group">
                    <label>å¹´çº§</label>
                    <select id="paper-grade">
                        <option value="é«˜ä¸€">é«˜ä¸€</option>
                        <option value="é«˜äºŒ">é«˜äºŒ</option>
                        <option value="é«˜ä¸‰">é«˜ä¸‰</option>
                        <option value="åˆä¸‰">åˆä¸‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è€ƒè¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="paper-time" value="120" min="30" max="180">
                </div>
                <button class="btn btn-success" onclick="savePaperInfo()">ä¸‹ä¸€æ­¥ï¼šæ·»åŠ é¢˜ç›®</button>
                <button class="btn" onclick="showPaperLibrary()">è¿”å›</button>
            </div>
        </div>

        <!-- æ·»åŠ é¢˜ç›®é¢æ¿ -->
        <div id="add-questions-panel" class="hidden">
            <div class="card">
                <h2>ğŸ“ æ·»åŠ é¢˜ç›®</h2>
                <p id="current-paper-info" style="color: #666; margin-bottom: 16px;"></p>
                
                <div class="form-group">
                    <label>é¢˜ç›®ç±»å‹</label>
                    <select id="question-type" onchange="toggleQuestionOptions()">
                        <option value="choice">é€‰æ‹©é¢˜</option>
                        <option value="fillblank">å¡«ç©ºé¢˜</option>
                        <option value="truefalse">åˆ¤æ–­é¢˜</option>
                        <option value="subjective">ä¸»è§‚é¢˜/è§£ç­”é¢˜</option>
                        <option value="reading">ğŸ“– é˜…è¯»ç†è§£é¢˜ï¼ˆè¯­æ–‡ä¸“ç”¨ï¼‰</option>
                    </select>
                </div>
                
                <!-- é˜…è¯»ç†è§£é¢˜ä¸“ç”¨ç•Œé¢ -->
                <div id="reading-section" style="display: none;">
                    <!-- æ­¥éª¤1ï¼šè¾“å…¥æ–‡ç«  -->
                    <div id="reading-step1" class="form-group">
                        <label>ğŸ“„ ç¬¬ä¸€æ­¥ï¼šè¾“å…¥é˜…è¯»æ–‡ç« </label>
                        <textarea id="reading-article-content" rows="8" placeholder="è¯·è¾“å…¥é˜…è¯»æ–‡ç« çš„å†…å®¹"></textarea>
                        <button class="btn btn-success" onclick="confirmReadingArticle()" style="margin-top: 10px;">âœ… ç¡®è®¤æ–‡ç« ï¼Œå¼€å§‹æ·»åŠ å°é¢˜</button>
                    </div>
                    
                    <!-- æ­¥éª¤2ï¼šæ·»åŠ å­é¢˜ç›® -->
                    <div id="reading-step2" style="display: none;">
                        <div class="card" style="background: #f6ffed; margin-bottom: 16px;">
                            <p><strong>ğŸ“„ å½“å‰æ–‡ç« ï¼š</strong></p>
                            <div id="reading-article-preview" style="max-height: 100px; overflow-y: auto; padding: 8px; background: white; border-radius: 4px;"></div>
                        </div>
                        
                        <!-- å·²æ·»åŠ çš„å­é¢˜ç›®åˆ—è¡¨ -->
                        <div id="reading-subquestions-list" style="margin-bottom: 16px;"></div>
                        
                        <!-- æ·»åŠ æ–°å­é¢˜ç›® -->
                        <div class="card" style="background: #e6f7ff; border: 1px solid #1890ff;">
                            <h4>â• æ·»åŠ ç¬¬ <span id="reading-subquestion-number">1</span> å°é¢˜</h4>
                            
                            <div class="form-group">
                                <label>å­é¢˜ç›®ç±»å‹</label>
                                <select id="reading-sub-type" onchange="toggleReadingSubOptions()">
                                    <option value="choice">é€‰æ‹©é¢˜</option>
                                    <option value="shortanswer">ç®€ç­”é¢˜</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>é¢˜ç›®å†…å®¹</label>
                                <textarea id="reading-sub-content" rows="3" placeholder="è¯·è¾“å…¥å°é¢˜å†…å®¹"></textarea>
                            </div>
                            
                            <div id="reading-sub-options-div" class="form-group">
                                <label>é€‰é¡¹ï¼ˆæ¯è¡Œä¸€ä¸ªé€‰é¡¹ï¼‰</label>
                                <textarea id="reading-sub-options" rows="3" placeholder="A. é€‰é¡¹ä¸€&#10;B. é€‰é¡¹äºŒ&#10;C. é€‰é¡¹ä¸‰&#10;D. é€‰é¡¹å››"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>æ­£ç¡®ç­”æ¡ˆ</label>
                                <div id="reading-sub-answer-choice" style="display: block;">
                                    <select id="reading-sub-answer-select">
                                        <option value="">è¯·é€‰æ‹©ç­”æ¡ˆ</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                    </select>
                                </div>
                                <div id="reading-sub-answer-text" style="display: none;">
                                    <input type="text" id="reading-sub-answer-input" placeholder="è¯·è¾“å…¥å‚è€ƒç­”æ¡ˆ">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>ç­”æ¡ˆè§£æ</label>
                                <textarea id="reading-sub-explanation" rows="2" placeholder="è¯·è¾“å…¥ç­”æ¡ˆè§£æ"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>åˆ†å€¼</label>
                                <input type="number" id="reading-sub-score" value="5" min="1" max="50">
                            </div>
                            
                            <button class="btn btn-success" onclick="addReadingSubQuestion()">â• æ·»åŠ è¿™é“å°é¢˜</button>
                        </div>
                        
                        <div style="margin-top: 16px;">
                            <button class="btn btn-success" onclick="finishReadingQuestion()">âœ… å®Œæˆé˜…è¯»ç†è§£é¢˜</button>
                            <button class="btn btn-danger" onclick="cancelReadingQuestion()">âŒ å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
                
                <!-- æ™®é€šé¢˜ç›®è¾“å…¥ï¼ˆéé˜…è¯»ç†è§£ï¼‰ -->
                <div id="normal-question-section">
                    <div class="form-group">
                        <label>é¢˜ç›®å†…å®¹</label>
                        <textarea id="question-content" rows="4" placeholder="è¯·è¾“å…¥é¢˜ç›®å†…å®¹ï¼Œæ”¯æŒæ¢è¡Œ"></textarea>
                    </div>
                    
                    <div id="choice-options" class="form-group">
                        <label>é€‰é¡¹ï¼ˆæ¯è¡Œä¸€ä¸ªé€‰é¡¹ï¼‰</label>
                        <textarea id="question-options" rows="4" placeholder="A. é€‰é¡¹ä¸€&#10;B. é€‰é¡¹äºŒ&#10;C. é€‰é¡¹ä¸‰&#10;D. é€‰é¡¹å››"></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>æ­£ç¡®ç­”æ¡ˆ</label>
                    <div id="answer-choice" style="display: block;">
                        <select id="question-answer-choice">
                            <option value="">è¯·é€‰æ‹©ç­”æ¡ˆ</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    <div id="answer-truefalse" style="display: none;">
                        <select id="question-answer-truefalse">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="æ­£ç¡®">æ­£ç¡®</option>
                            <option value="é”™è¯¯">é”™è¯¯</option>
                        </select>
                    </div>
                    <div id="answer-text" style="display: none;">
                        <input type="text" id="question-answer-text" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ç­”æ¡ˆè§£æ</label>
                    <textarea id="question-explanation" rows="3" placeholder="è¯·è¾“å…¥ç­”æ¡ˆè§£æ"></textarea>
                </div>
                
                <div class="form-group">
                    <label>çŸ¥è¯†ç‚¹</label>
                    <input type="text" id="question-knowledge" placeholder="ä¾‹å¦‚ï¼šå‡½æ•°ã€ä¸‰è§’å‡½æ•°ã€å¯¼æ•°">
                </div>
                
                <div class="form-group">
                    <label>åˆ†å€¼</label>
                    <input type="number" id="question-score" value="5" min="1" max="50">
                </div>
                
                <button class="btn btn-success" onclick="addQuestionToPaper()">æ·»åŠ é¢˜ç›®</button>
                <button class="btn" onclick="finishAddingQuestions()">å®Œæˆæ·»åŠ </button>
                <button class="btn" onclick="showAddPaperPanel()">è¿”å›</button>
            </div>
            
            <div id="added-questions-preview" style="margin-top: 20px;"></div>
        </div>

        <!-- ç¼–è¾‘è¯•å·é¢æ¿ -->
        <div id="edit-paper-panel" class="hidden">
            <div class="card">
                <h2>âœï¸ ç¼–è¾‘è¯•å·</h2>
                <input type="hidden" id="edit-paper-id">
                
                <div class="form-group">
                    <label>è¯•å·æ ‡é¢˜</label>
                    <input type="text" id="edit-paper-title">
                </div>
                <div class="form-group">
                    <label>è€ƒè¯•ç±»å‹</label>
                    <select id="edit-paper-exam-type">
                        <option value="é«˜è€ƒ">é«˜è€ƒ</option>
                        <option value="ä¸­è€ƒ">ä¸­è€ƒ</option>
                        <option value="æœŸæœ«è”è€ƒ">æœŸæœ«è”è€ƒ</option>
                        <option value="æœŸä¸­è€ƒè¯•">æœŸä¸­è€ƒè¯•</option>
                        <option value="æ¨¡æ‹Ÿè€ƒè¯•">æ¨¡æ‹Ÿè€ƒè¯•</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>çœä»½/åœ°åŒº</label>
                    <input type="text" id="edit-paper-province">
                </div>
                <div class="form-group">
                    <label>ç§‘ç›®</label>
                    <select id="edit-paper-subject">
                        <option value="æ•°å­¦">æ•°å­¦</option>
                        <option value="è¯­æ–‡">è¯­æ–‡</option>
                        <option value="è‹±è¯­">è‹±è¯­</option>
                        <option value="ç‰©ç†">ç‰©ç†</option>
                        <option value="åŒ–å­¦">åŒ–å­¦</option>
                        <option value="ç”Ÿç‰©">ç”Ÿç‰©</option>
                        <option value="å†å²">å†å²</option>
                        <option value="åœ°ç†">åœ°ç†</option>
                        <option value="æ”¿æ²»">æ”¿æ²»</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¹´ä»½</label>
                    <input type="number" id="edit-paper-year" min="2010" max="2030">
                </div>
                <div class="form-group">
                    <label>å¹´çº§</label>
                    <select id="edit-paper-grade">
                        <option value="é«˜ä¸€">é«˜ä¸€</option>
                        <option value="é«˜äºŒ">é«˜äºŒ</option>
                        <option value="é«˜ä¸‰">é«˜ä¸‰</option>
                        <option value="åˆä¸‰">åˆä¸‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è€ƒè¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="edit-paper-time" min="30" max="180">
                </div>
                
                <h3 style="margin-top: 24px; margin-bottom: 16px;">ğŸ“ é¢˜ç›®åˆ—è¡¨</h3>
                <div id="edit-questions-list" style="margin-bottom: 20px;"></div>
                
                <h3 style="margin-top: 24px; margin-bottom: 16px;">â• æ·»åŠ æ–°é¢˜ç›®</h3>
                <div class="form-group">
                    <label>é¢˜ç›®ç±»å‹</label>
                    <select id="edit-question-type" onchange="toggleEditQuestionOptions()">
                        <option value="choice">é€‰æ‹©é¢˜</option>
                        <option value="fillblank">å¡«ç©ºé¢˜</option>
                        <option value="truefalse">åˆ¤æ–­é¢˜</option>
                        <option value="subjective">ä¸»è§‚é¢˜/è§£ç­”é¢˜</option>
                        <option value="reading">ğŸ“– é˜…è¯»ç†è§£é¢˜</option>
                    </select>
                </div>
                
                <!-- æ™®é€šé¢˜ç›®è¾“å…¥åŒºåŸŸ -->
                <div id="edit-normal-question-section">
                    <div class="form-group">
                        <label id="edit-content-label">é¢˜ç›®å†…å®¹</label>
                        <textarea id="edit-question-content" rows="3" placeholder="è¯·è¾“å…¥é¢˜ç›®å†…å®¹"></textarea>
                    </div>
                    
                    <div id="edit-choice-options-div" class="form-group">
                        <label>é€‰é¡¹ï¼ˆæ¯è¡Œä¸€ä¸ªé€‰é¡¹ï¼‰</label>
                        <textarea id="edit-question-options" rows="3" placeholder="A. é€‰é¡¹ä¸€&#10;B. é€‰é¡¹äºŒ&#10;C. é€‰é¡¹ä¸‰&#10;D. é€‰é¡¹å››"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>æ­£ç¡®ç­”æ¡ˆ</label>
                        <div id="edit-answer-choice" style="display: block;">
                            <select id="edit-question-answer-choice">
                                <option value="">è¯·é€‰æ‹©ç­”æ¡ˆ</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                        <div id="edit-answer-truefalse" style="display: none;">
                            <select id="edit-question-answer-truefalse">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="æ­£ç¡®">æ­£ç¡®</option>
                                <option value="é”™è¯¯">é”™è¯¯</option>
                            </select>
                        </div>
                        <div id="edit-answer-text" style="display: none;">
                            <input type="text" id="edit-question-answer-text" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ç­”æ¡ˆè§£æ</label>
                        <textarea id="edit-question-explanation" rows="2" placeholder="è¯·è¾“å…¥ç­”æ¡ˆè§£æ"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>çŸ¥è¯†ç‚¹</label>
                        <input type="text" id="edit-question-knowledge" placeholder="ä¾‹å¦‚ï¼šå‡½æ•°ã€ä¸‰è§’å‡½æ•°ã€å¯¼æ•°">
                    </div>
                    
                    <div class="form-group">
                        <label>åˆ†å€¼</label>
                        <input type="number" id="edit-question-score" value="5" min="1" max="50">
                    </div>
                    
                    <button class="btn btn-success" onclick="addQuestionToExistingPaper()">æ·»åŠ é¢˜ç›®</button>
                </div>
                
                <!-- é˜…è¯»ç†è§£é¢˜ä¸“ç”¨åŒºåŸŸ -->
                <div id="edit-reading-section" style="display: none;">
                    <!-- æ­¥éª¤1ï¼šè¾“å…¥æ–‡ç«  -->
                    <div id="edit-reading-step1" class="form-group">
                        <label>ğŸ“„ ç¬¬ä¸€æ­¥ï¼šè¾“å…¥é˜…è¯»æ–‡ç« </label>
                        <textarea id="edit-reading-article" rows="8" placeholder="è¯·è¾“å…¥é˜…è¯»æ–‡ç« çš„å†…å®¹"></textarea>
                        <button class="btn btn-success" onclick="confirmEditReadingArticle()" style="margin-top: 10px;">âœ… ç¡®è®¤æ–‡ç« ï¼Œå¼€å§‹æ·»åŠ å°é¢˜</button>
                    </div>
                    
                    <!-- æ­¥éª¤2ï¼šæ·»åŠ å­é¢˜ç›® -->
                    <div id="edit-reading-step2" style="display: none;">
                        <div class="card" style="background: #f6ffed; margin-bottom: 16px;">
                            <p><strong>ğŸ“„ å½“å‰æ–‡ç« ï¼š</strong></p>
                            <div id="edit-reading-article-preview" style="max-height: 100px; overflow-y: auto; padding: 8px; background: white; border-radius: 4px;"></div>
                        </div>
                        
                        <!-- å·²æ·»åŠ çš„å­é¢˜ç›®åˆ—è¡¨ -->
                        <div id="edit-reading-subquestions-list" style="margin-bottom: 16px;"></div>
                        
                        <!-- æ·»åŠ æ–°å­é¢˜ç›® -->
                        <div class="card" style="background: #e6f7ff; border: 1px solid #1890ff;">
                            <h4>â• æ·»åŠ ç¬¬ <span id="edit-reading-subquestion-number">1</span> å°é¢˜</h4>
                            
                            <div class="form-group">
                                <label>å­é¢˜ç›®ç±»å‹</label>
                                <select id="edit-reading-sub-type" onchange="toggleEditReadingSubOptions()">
                                    <option value="choice">é€‰æ‹©é¢˜</option>
                                    <option value="shortanswer">ç®€ç­”é¢˜</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>é¢˜ç›®å†…å®¹</label>
                                <textarea id="edit-reading-sub-content" rows="3" placeholder="è¯·è¾“å…¥å°é¢˜å†…å®¹"></textarea>
                            </div>
                            
                            <div id="edit-reading-sub-options-div" class="form-group">
                                <label>é€‰é¡¹ï¼ˆæ¯è¡Œä¸€ä¸ªé€‰é¡¹ï¼‰</label>
                                <textarea id="edit-reading-sub-options" rows="3" placeholder="A. é€‰é¡¹ä¸€&#10;B. é€‰é¡¹äºŒ&#10;C. é€‰é¡¹ä¸‰&#10;D. é€‰é¡¹å››"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>æ­£ç¡®ç­”æ¡ˆ</label>
                                <div id="edit-reading-sub-answer-choice" style="display: block;">
                                    <select id="edit-reading-sub-answer-select">
                                        <option value="">è¯·é€‰æ‹©ç­”æ¡ˆ</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                    </select>
                                </div>
                                <div id="edit-reading-sub-answer-text" style="display: none;">
                                    <input type="text" id="edit-reading-sub-answer-input" placeholder="è¯·è¾“å…¥å‚è€ƒç­”æ¡ˆ">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>ç­”æ¡ˆè§£æ</label>
                                <textarea id="edit-reading-sub-explanation" rows="2" placeholder="è¯·è¾“å…¥ç­”æ¡ˆè§£æ"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>åˆ†å€¼</label>
                                <input type="number" id="edit-reading-sub-score" value="5" min="1" max="50">
                            </div>
                            
                            <button class="btn btn-success" onclick="addEditReadingSubQuestion()">â• æ·»åŠ è¿™é“å°é¢˜</button>
                        </div>
                        
                        <div style="margin-top: 16px;">
                            <button class="btn btn-success" onclick="finishEditReadingQuestion()">âœ… å®Œæˆé˜…è¯»ç†è§£é¢˜</button>
                            <button class="btn btn-danger" onclick="cancelEditReadingQuestion()">âŒ å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="savePaperChanges()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                <button class="btn" onclick="showPaperLibrary()">è¿”å›è¯•å·åº“</button>
            </div>
        </div>

        <!-- åˆ›å»ºè€ƒè¯• -->
        <div id="create-exam" class="hidden">
            <div class="card">
                <h2>åˆ›å»ºæ–°è€ƒè¯•</h2>
                <div class="form-group">
                    <label>è€ƒè¯•åç§°</label>
                    <input type="text" id="exam-title" placeholder="ä¾‹å¦‚ï¼šæ•°å­¦æœŸä¸­æµ‹è¯•">
                </div>
                <div class="form-group">
                    <label>ç§‘ç›®</label>
                    <select id="exam-subject">
                        <option value="math">æ•°å­¦</option>
                        <option value="chinese">è¯­æ–‡</option>
                        <option value="english">è‹±è¯­</option>
                        <option value="physics">ç‰©ç†</option>
                        <option value="chemistry">åŒ–å­¦</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¹´çº§</label>
                    <select id="exam-grade">
                        <option value="å°å­¦ä¸‰å¹´çº§">å°å­¦ä¸‰å¹´çº§</option>
                        <option value="å°å­¦å››å¹´çº§">å°å­¦å››å¹´çº§</option>
                        <option value="å°å­¦äº”å¹´çº§">å°å­¦äº”å¹´çº§</option>
                        <option value="å°å­¦å…­å¹´çº§">å°å­¦å…­å¹´çº§</option>
                        <option value="åˆä¸­ä¸€å¹´çº§">åˆä¸­ä¸€å¹´çº§</option>
                        <option value="åˆä¸­äºŒå¹´çº§">åˆä¸­äºŒå¹´çº§</option>
                        <option value="åˆä¸­ä¸‰å¹´çº§">åˆä¸­ä¸‰å¹´çº§</option>
                        <option value="é«˜ä¸­ä¸€å¹´çº§">é«˜ä¸­ä¸€å¹´çº§</option>
                        <option value="é«˜ä¸­äºŒå¹´çº§">é«˜ä¸­äºŒå¹´çº§</option>
                        <option value="é«˜ä¸­ä¸‰å¹´çº§">é«˜ä¸­ä¸‰å¹´çº§</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>éš¾åº¦</label>
                    <select id="exam-difficulty">
                        <option value="easy">åŸºç¡€</option>
                        <option value="medium" selected>ä¸­ç­‰</option>
                        <option value="hard">è¾ƒéš¾</option>
                        <option value="challenge">æŒ‘æˆ˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é¢˜ç›®æ•°é‡</label>
                    <input type="number" id="exam-count" value="10" min="1" max="50">
                </div>
                <div class="form-group">
                    <label>è€ƒè¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="exam-time" value="60" min="5" max="180">
                </div>
                <button class="btn" onclick="createExam()">ç”Ÿæˆé¢˜ç›®å¹¶åˆ›å»º</button>
                <button class="btn" onclick="showTeacherPanel()">è¿”å›</button>
            </div>
            <div id="question-preview"></div>
        </div>

        <!-- å­¦ç”Ÿé¢æ¿ -->
        <div id="student-panel" class="hidden">
            <div class="card">
                <h2>å­¦ç”Ÿç«¯ - åŠ å…¥è€ƒè¯•</h2>
                <button class="btn" onclick="showRoleSelect()">è¿”å›</button>
            </div>
            <div id="active-exams"></div>
        </div>

        <!-- å­¦ç”Ÿä¿¡æ¯è¾“å…¥æ¨¡æ€æ¡† -->
        <div id="student-info-modal" class="modal hidden">
            <div class="card" style="max-width: 400px; width: 90%;">
                <h3>å¡«å†™è€ƒç”Ÿä¿¡æ¯</h3>
                <div class="form-group">
                    <label>å§“å</label>
                    <input type="text" id="student-name-input" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                <div class="form-group">
                    <label>å­¦å·</label>
                    <input type="text" id="student-id-input" placeholder="è¯·è¾“å…¥å­¦å·">
                </div>
                <div class="form-group">
                    <label>ç­çº§</label>
                    <input type="text" id="student-class-input" placeholder="è¯·è¾“å…¥ç­çº§ï¼ˆå¦‚ï¼šé«˜ä¸€1ç­ï¼‰">
                </div>
                <div id="join-exam-info" style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;"></div>
                <button class="btn btn-success" onclick="confirmJoinExam()">å¼€å§‹ç­”é¢˜</button>
                <button class="btn" onclick="closeStudentModal()">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- è€ƒè¯•è¯¦æƒ…ç»Ÿè®¡æ¨¡æ€æ¡† -->
        <div id="exam-stats-modal" class="modal hidden">
            <div class="card" style="max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto;">
                <h2>è€ƒè¯•ç»Ÿè®¡è¯¦æƒ…</h2>
                <div id="exam-stats-content"></div>
                <button class="btn" onclick="closeExamStatsModal()" style="margin-top: 20px;">å…³é—­</button>
            </div>
        </div>

        <!-- æŸ¥æ‰¾è€ƒè¯•æ¨¡æ€æ¡† -->
        <div id="search-exam-modal" class="modal hidden">
            <div class="card" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                <h2>ğŸ” æŸ¥æ‰¾è€ƒè¯•</h2>
                <div style="margin: 20px 0;">
                    <div class="form-group">
                        <label>è¾“å…¥è€ƒè¯•åç§°æˆ–ID</label>
                        <input type="text" id="exam-search-input" placeholder="ä¾‹å¦‚ï¼šé«˜ä¸€æ•°å­¦ç»¼åˆæµ‹è¯•å· æˆ– b7e8edf1..." style="width: 100%;">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-success" onclick="searchExams()">æœç´¢</button>
                        <button class="btn" onclick="clearExamSearch()">æ¸…é™¤</button>
                        <button class="btn" onclick="closeSearchExamModal()">å…³é—­</button>
                    </div>
                </div>
                <div id="search-exam-results" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- é€‰æ‹©è€ƒè¯•ç­çº§æ¨¡æ€æ¡† -->
        <div id="select-exam-class-modal" class="modal hidden">
            <div class="card" style="max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <h2>ğŸ“‹ é€‰æ‹©è€ƒè¯•ç­çº§</h2>
                <p style="color: #666; margin: 10px 0;">è¯·é€‰æ‹©å‚åŠ æœ¬æ¬¡è€ƒè¯•çš„ç­çº§ï¼ˆå¯å¤šé€‰ï¼‰ï¼š</p>
                <div id="exam-class-options" style="margin: 20px 0;">
                    <!-- åŠ¨æ€ç”Ÿæˆç­çº§é€‰é¡¹ -->
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="confirmStartExamWithClass()">ç¡®å®šå¼€å§‹è€ƒè¯•</button>
                    <button class="btn" onclick="closeSelectExamClassModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- æŸ¥çœ‹å­¦ç”ŸåŸå·æ¨¡æ€æ¡† -->
        <div id="student-paper-modal" class="modal hidden">
            <div class="card" style="max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto;">
                <h2>ğŸ“„ å­¦ç”ŸåŸå·</h2>
                <div id="student-paper-info" style="margin-bottom: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px;"></div>
                <div id="student-paper-content"></div>
                <button class="btn" onclick="closeStudentPaperModal()" style="margin-top: 20px;">å…³é—­</button>
            </div>
        </div>

        <!-- è€ƒè¯•é¡µé¢ -->
        <div id="exam-page" class="hidden">
            <div class="timer" id="timer">00:00</div>
            <div class="card">
                <h2 id="exam-title-display"></h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <p id="progress-text">å·²ä½œç­” 0/0 é¢˜</p>
            </div>
            <div id="question-nav"></div>
            <div id="question-container"></div>
            <div class="nav-buttons">
                <button class="btn" onclick="prevQuestion()">ä¸Šä¸€é¢˜</button>
                <button class="btn" id="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¢˜</button>
            </div>
        </div>
    </div>

    <script>
        // åŠ¨æ€è·å–APIåœ°å€ï¼ˆæ”¯æŒæœ¬åœ°å’Œå±€åŸŸç½‘è®¿é—®ï¼‰
        const API_URL = `http://${window.location.hostname}:3001/api`;
        let currentExam = null;
        let currentQuestions = [];
        let currentAnswers = {};
        let currentQuestionIndex = 0;
        let timeLeft = 0;
        let timerInterval = null;
        let studentInfo = {};

        // é¡µé¢åˆ‡æ¢
        // å½“å‰ç™»å½•çš„æ•™å¸ˆä¿¡æ¯
        let currentTeacher = null;

        function showRoleSelect() {
            hideAll();
            document.getElementById('role-select').classList.remove('hidden');
        }

        // æ˜¾ç¤ºæ•™å¸ˆç™»å½•é¢æ¿
        function showTeacherLoginPanel() {
            hideAll();
            document.getElementById('teacher-login-panel').classList.remove('hidden');
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const savedTeacher = localStorage.getItem('currentTeacher');
            if (savedTeacher) {
                currentTeacher = JSON.parse(savedTeacher);
                showTeacherPanel();
            }
        }

        // æ˜¾ç¤ºç™»å½•è¡¨å•
        function showTeacherLoginForm() {
            document.getElementById('teacher-login-form').style.display = 'block';
            document.getElementById('teacher-register-form').style.display = 'none';
        }

        // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
        function showTeacherRegisterForm() {
            document.getElementById('teacher-login-form').style.display = 'none';
            document.getElementById('teacher-register-form').style.display = 'block';
        }

        // æ•™å¸ˆç™»å½•
        async function teacherLogin() {
            const username = document.getElementById('teacher-username').value.trim();
            const password = document.getElementById('teacher-password').value;
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/teacher/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                if (data.success) {
                    currentTeacher = data.teacher;
                    localStorage.setItem('currentTeacher', JSON.stringify(currentTeacher));
                    alert(`æ¬¢è¿ï¼Œ${currentTeacher.name}è€å¸ˆï¼`);
                    showTeacherPanel();
                } else {
                    alert(data.error || 'ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                alert('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // æ•™å¸ˆæ³¨å†Œ
        async function teacherRegister() {
            const username = document.getElementById('teacher-reg-username').value.trim();
            const password = document.getElementById('teacher-reg-password').value;
            const name = document.getElementById('teacher-reg-name').value.trim();
            const subject = document.getElementById('teacher-reg-subject').value;

            // è·å–é€‰ä¸­çš„ç­çº§
            const classCheckboxes = document.querySelectorAll('#teacher-reg-classes input[type="checkbox"]:checked');
            const classes = Array.from(classCheckboxes).map(cb => cb.value);

            if (!username || !password || !name || !subject) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
                return;
            }

            if (classes.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ‰€æ•™ç­çº§');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/teacher/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, name, subject, classes })
                });

                const data = await response.json();
                if (data.success) {
                    alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                    showTeacherLoginForm();
                    // æ¸…ç©ºæ³¨å†Œè¡¨å•
                    document.getElementById('teacher-reg-username').value = '';
                    document.getElementById('teacher-reg-password').value = '';
                    document.getElementById('teacher-reg-name').value = '';
                    document.getElementById('teacher-reg-subject').value = '';
                    document.querySelectorAll('#teacher-reg-classes input[type="checkbox"]').forEach(cb => cb.checked = false);
                } else {
                    alert(data.error || 'æ³¨å†Œå¤±è´¥');
                }
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                alert('æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // æ•™å¸ˆé€€å‡ºç™»å½•
        function teacherLogout() {
            currentTeacher = null;
            localStorage.removeItem('currentTeacher');
            showTeacherLoginPanel();
        }

        function showTeacherPanel() {
            hideAll();
            document.getElementById('teacher-panel').classList.remove('hidden');
            // æ˜¾ç¤ºæ•™å¸ˆä¿¡æ¯
            if (currentTeacher) {
                document.getElementById('teacher-name-display').textContent = currentTeacher.name + 'è€å¸ˆ';
                document.getElementById('teacher-subject-display').textContent = currentTeacher.subject;

                // æ˜¾ç¤ºæ‰€æ•™ç­çº§ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
                let classesDisplay = '';
                if (currentTeacher.classes) {
                    let teacherClasses = [];
                    try {
                        teacherClasses = JSON.parse(currentTeacher.classes);
                    } catch (e) {
                        teacherClasses = currentTeacher.classes.split(',').map(c => c.trim());
                    }
                    // è½¬æ¢æ—§æ ¼å¼ï¼ˆå¦‚"1ç­"ï¼‰ä¸ºæ–°æ ¼å¼ï¼ˆå¦‚"é«˜ä¸€1ç­"ï¼‰ç”¨äºæ˜¾ç¤º
                    const displayClasses = teacherClasses.map(cls => {
                        if (cls.startsWith('é«˜ä¸€') || cls.startsWith('é«˜äºŒ') || cls.startsWith('é«˜ä¸‰')) {
                            return cls;
                        } else {
                            return 'é«˜ä¸€' + cls; // æ—§æ ¼å¼é»˜è®¤æ˜¾ç¤ºä¸ºé«˜ä¸€
                        }
                    });
                    classesDisplay = 'ğŸ“š æ‰€æ•™ç­çº§ï¼š' + displayClasses.join('ã€');
                }
                document.getElementById('teacher-classes-display').textContent = classesDisplay;

                // åŠ è½½ä»»åŠ¡ç»Ÿè®¡
                loadTeacherTaskStats();
            }
            loadExamList();
        }

        // åŠ è½½æ•™å¸ˆä»»åŠ¡ç»Ÿè®¡
        async function loadTeacherTaskStats() {
            if (!currentTeacher) return;
            
            try {
                const response = await fetch(`${API_URL}/teacher/${currentTeacher.id}/stats`);
                const data = await response.json();
                
                if (data.stats && data.stats.pending_count > 0) {
                    document.getElementById('teacher-task-stats').textContent = `(å¾…æ‰¹æ”¹: ${data.stats.pending_count}é¢˜)`;
                } else {
                    document.getElementById('teacher-task-stats').textContent = '';
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ•™å¸ˆæ‰¹æ”¹ä»»åŠ¡é¢æ¿
        function showTeacherTasks() {
            hideAll();
            document.getElementById('teacher-tasks-panel').classList.remove('hidden');
            loadTeacherTasks('pending');
        }

        // åŠ è½½æ•™å¸ˆæ‰¹æ”¹ä»»åŠ¡
        async function loadTeacherTasks(status) {
            if (!currentTeacher) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.getElementById('btn-pending-tasks').className = status === 'pending' ? 'btn btn-success' : 'btn';
            document.getElementById('btn-graded-tasks').className = status === 'graded' ? 'btn btn-success' : 'btn';
            
            try {
                const response = await fetch(`${API_URL}/teacher/${currentTeacher.id}/tasks?status=${status}`);
                const data = await response.json();
                
                const listDiv = document.getElementById('teacher-tasks-list');
                
                if (!data.tasks || data.tasks.length === 0) {
                    listDiv.innerHTML = `<div class="card"><p>æš‚æ— ${status === 'pending' ? 'å¾…æ‰¹æ”¹' : 'å·²æ‰¹æ”¹'}çš„ä»»åŠ¡</p></div>`;
                    return;
                }
                
                listDiv.innerHTML = data.tasks.map(task => {
                    const isGraded = task.status === 'graded';
                    let questionContent = task.question_content;
                    let isSubQuestion = task.sub_question_index >= 0;
                    let fullScore = isSubQuestion ? task.sub_question_score : task.full_score;
                    
                    // å¤„ç†é˜…è¯»ç†è§£é¢˜çš„ç®€ç­”é¢˜
                    if (isSubQuestion) {
                        questionContent = `
                            <div style="background: #f6ffed; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <strong>ğŸ“– é˜…è¯»ç†è§£é¢˜ - ç¬¬${task.sub_question_index + 1}å°é¢˜ï¼ˆç®€ç­”é¢˜ï¼‰</strong>
                            </div>
                            <div style="margin-bottom: 12px;"><strong>é¢˜ç›®ï¼š</strong>${task.sub_question_content}</div>
                            <div style="color: #666; font-size: 12px;"><strong>å‚è€ƒç­”æ¡ˆï¼š</strong>${task.sub_question_answer}</div>
                        `;
                    } else if (task.question_type === 'reading' && task.article) {
                        questionContent = `<strong>ã€é˜…è¯»ç†è§£ã€‘</strong><br>${task.article.substring(0, 200)}...`;
                    }
                    
                    return `
                        <div class="card" style="margin-bottom: 16px; border-left: 4px solid ${isGraded ? '#52c41a' : '#faad14'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <strong>${task.exam_title}</strong>
                                <span style="color: ${isGraded ? '#52c41a' : '#faad14'}; font-weight: bold;">
                                    ${isGraded ? 'âœ… å·²æ‰¹æ”¹' : 'â³ å¾…æ‰¹æ”¹'}
                                </span>
                            </div>
                            <p><strong>å­¦ç”Ÿï¼š</strong>${task.student_name} (${task.student_id})</p>
                            <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin: 12px 0;">
                                <div style="margin-bottom: 12px;">${questionContent}</div>
                                <p><strong>å­¦ç”Ÿç­”æ¡ˆï¼š</strong></p>
                                <div style="background: white; padding: 8px; border-radius: 4px;">${task.student_answer || 'æœªä½œç­”'}</div>
                            </div>
                            ${!isGraded ? `
                                <div style="background: #e6f7ff; padding: 16px; border-radius: 8px; margin-top: 12px;">
                                    <div class="form-group">
                                        <label><strong>è¯„åˆ†ï¼ˆæ»¡åˆ†${fullScore}åˆ†ï¼‰ï¼š</strong></label>
                                        <input type="number" id="task-score-${task.id}" min="0" max="${fullScore}" value="" 
                                               style="width: 100px; padding: 8px; font-size: 16px;">
                                        <span> / ${fullScore}åˆ†</span>
                                    </div>
                                    <div class="form-group">
                                        <label><strong>è¯„è¯­ï¼š</strong></label>
                                        <textarea id="task-comment-${task.id}" rows="2" placeholder="å¯é€‰å¡«è¯„è¯­" 
                                                  style="width: 100%; padding: 8px;"></textarea>
                                    </div>
                                    <button class="btn btn-success" onclick="submitTaskGrade('${task.id}')">âœ… æäº¤æ‰¹æ”¹</button>
                                </div>
                            ` : `
                                <div style="background: #f6ffed; padding: 16px; border-radius: 8px; margin-top: 12px;">
                                    <p><strong>å¾—åˆ†ï¼š</strong><span style="color: #52c41a; font-size: 20px;">${task.assigned_score}</span> / ${fullScore}åˆ†</p>
                                    ${task.teacher_comment ? `<p><strong>è¯„è¯­ï¼š</strong>${task.teacher_comment}</p>` : ''}
                                    <p style="color: #999; font-size: 12px;">æ‰¹æ”¹æ—¶é—´ï¼š${new Date(task.graded_at).toLocaleString()}</p>
                                </div>
                            `}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                document.getElementById('teacher-tasks-list').innerHTML = '<div class="card"><p style="color: red;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p></div>';
            }
        }

        // æäº¤ä»»åŠ¡æ‰¹æ”¹
        async function submitTaskGrade(taskId) {
            const score = document.getElementById(`task-score-${taskId}`).value;
            const comment = document.getElementById(`task-comment-${taskId}`).value;
            
            if (score === '' || score === null) {
                alert('è¯·è¾“å…¥åˆ†æ•°');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/teacher/task/${taskId}/grade`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ score: parseInt(score), comment })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('æ‰¹æ”¹å®Œæˆï¼');
                    loadTeacherTasks('pending');
                    loadTeacherTaskStats();
                } else {
                    alert(data.error || 'æäº¤å¤±è´¥');
                }
            } catch (error) {
                console.error('æäº¤æ‰¹æ”¹å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function showStudentPanel() {
            hideAll();
            document.getElementById('student-panel').classList.remove('hidden');
            loadActiveExams();
        }

        function showCreateExam() {
            hideAll();
            document.getElementById('create-exam').classList.remove('hidden');
        }

        function hideAll() {
            document.getElementById('role-select').classList.add('hidden');
            document.getElementById('teacher-login-panel').classList.add('hidden');
            document.getElementById('teacher-panel').classList.add('hidden');
            document.getElementById('teacher-tasks-panel').classList.add('hidden');
            document.getElementById('create-exam').classList.add('hidden');
            document.getElementById('student-panel').classList.add('hidden');
            document.getElementById('exam-page').classList.add('hidden');
            document.getElementById('paper-library').classList.add('hidden');
            document.getElementById('add-paper-panel').classList.add('hidden');
            document.getElementById('add-questions-panel').classList.add('hidden');
            document.getElementById('edit-paper-panel').classList.add('hidden');
        }

        // ç”Ÿæˆé¢˜ç›®
        function generateQuestions(subject, grade, difficulty, count) {
            const questions = [];
            const types = ['choice', 'truefalse', 'fillblank', 'reading'];
            
            for (let i = 0; i < count; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                let question = { type, score: 10 };
                
                if (type === 'choice') {
                    question.content = `ç¬¬${i+1}é¢˜ï¼šè¿™æ˜¯ä¸€ä¸ª${subject}é€‰æ‹©é¢˜ç¤ºä¾‹`;
                    question.options = ['A. é€‰é¡¹1', 'B. é€‰é¡¹2', 'C. é€‰é¡¹3', 'D. é€‰é¡¹4'];
                    question.answer = 'A';
                    question.explanation = `æœ¬é¢˜è€ƒæŸ¥${subject}çŸ¥è¯†ç‚¹`;
                    question.knowledgePoint = subject;
                } else if (type === 'truefalse') {
                    question.content = `ç¬¬${i+1}é¢˜ï¼šè¿™æ˜¯ä¸€ä¸ª${subject}åˆ¤æ–­é¢˜ç¤ºä¾‹`;
                    question.options = ['æ­£ç¡®', 'é”™è¯¯'];
                    question.answer = 'æ­£ç¡®';
                    question.explanation = `æœ¬é¢˜è€ƒæŸ¥${subject}çŸ¥è¯†ç‚¹`;
                    question.knowledgePoint = subject;
                } else if (type === 'reading') {
                    // ç”Ÿæˆé˜…è¯»ç†è§£é¢˜
                    question.content = `ç¬¬${i+1}é¢˜ï¼šé˜…è¯»ç†è§£é¢˜`;
                    question.article = `è¿™æ˜¯ä¸€ç¯‡${subject}é˜…è¯»ææ–™ç¤ºä¾‹ã€‚é˜…è¯»ææ–™çš„å†…å®¹ä¼šæ ¹æ®ç§‘ç›®å’Œå¹´çº§è‡ªåŠ¨ç”Ÿæˆï¼ŒåŒ…å«ç›¸å…³çš„çŸ¥è¯†ç‚¹å’Œè€ƒæŸ¥å†…å®¹ã€‚å­¦ç”Ÿéœ€è¦ä»”ç»†é˜…è¯»ææ–™ï¼Œç„¶åå›ç­”åé¢çš„é—®é¢˜ã€‚`;
                    question.subQuestions = [
                        {
                            type: 'choice',
                            content: 'æ ¹æ®æ–‡ç« å†…å®¹ï¼Œä»¥ä¸‹å“ªä¸ªé€‰é¡¹æ˜¯æ­£ç¡®çš„ï¼Ÿ',
                            options: ['A. é€‰é¡¹ä¸€', 'B. é€‰é¡¹äºŒ', 'C. é€‰é¡¹ä¸‰', 'D. é€‰é¡¹å››'],
                            answer: 'A',
                            explanation: 'æ ¹æ®æ–‡ç« ç¬¬ä¸€æ®µå¯çŸ¥...',
                            score: 5,
                            subQuestionNumber: 1
                        },
                        {
                            type: 'shortanswer',
                            content: 'è¯·ç®€è¦æ¦‚æ‹¬æ–‡ç« çš„ä¸»è¦å†…å®¹ã€‚',
                            answer: 'å‚è€ƒç­”æ¡ˆç¤ºä¾‹',
                            explanation: 'éœ€è¦åŒ…å«æ–‡ç« çš„ä¸»è¦è§‚ç‚¹å’Œå…³é”®ä¿¡æ¯',
                            score: 5,
                            subQuestionNumber: 2
                        }
                    ];
                    question.options = [];
                    question.answer = 'ç¬¬1é¢˜ï¼šA\nç¬¬2é¢˜ï¼šï¼ˆç®€ç­”é¢˜ï¼Œéœ€äººå·¥æ‰¹æ”¹ï¼‰';
                    question.explanation = 'é˜…è¯»ç†è§£é¢˜åŒ…å«é€‰æ‹©é¢˜å’Œç®€ç­”é¢˜';
                    question.knowledgePoint = subject + 'é˜…è¯»ç†è§£';
                    question.score = 10;
                } else {
                    question.content = `ç¬¬${i+1}é¢˜ï¼šè¿™æ˜¯ä¸€ä¸ª${subject}å¡«ç©ºé¢˜ç¤ºä¾‹ï¼Œç­”æ¡ˆæ˜¯_____`;
                    question.options = [];
                    question.answer = 'ç­”æ¡ˆ';
                    question.explanation = `æœ¬é¢˜è€ƒæŸ¥${subject}çŸ¥è¯†ç‚¹`;
                    question.knowledgePoint = subject;
                }
                questions.push(question);
            }
            return questions;
        }

        // ä¸´æ—¶å­˜å‚¨ç”Ÿæˆçš„é¢˜ç›®
        let tempQuestions = [];

        // åˆ›å»ºè€ƒè¯•
        async function createExam() {
            const title = document.getElementById('exam-title').value;
            const subject = document.getElementById('exam-subject').value;
            const grade = document.getElementById('exam-grade').value;
            const difficulty = document.getElementById('exam-difficulty').value;
            const count = parseInt(document.getElementById('exam-count').value);
            const timeLimit = parseInt(document.getElementById('exam-time').value);

            if (!title) {
                alert('è¯·è¾“å…¥è€ƒè¯•åç§°');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½ä¸­
            const previewDiv = document.getElementById('question-preview');
            previewDiv.innerHTML = '<div class="card"><h3>æ­£åœ¨ç”Ÿæˆé¢˜ç›®...</h3><p>è¯·ç¨å€™ï¼Œç³»ç»Ÿæ­£åœ¨æ ¹æ®æ•™å­¦å¤§çº²ç”Ÿæˆç¬¦åˆè¦æ±‚çš„é¢˜ç›®</p></div>';

            try {
                // è°ƒç”¨åç«¯ API ç”ŸæˆçœŸå®é¢˜ç›®
                const response = await fetch(`${API_URL}/generate-questions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject,
                        grade,
                        difficulty,
                        count,
                        types: ['choice', 'truefalse', 'fillblank']
                    })
                });

                const data = await response.json();
                if (data.success) {
                    tempQuestions = data.questions;
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    previewDiv.innerHTML = '<div class="card"><h3>é¢˜ç›®é¢„è§ˆ</h3>' + 
                        tempQuestions.map((q, i) => {
                            const typeName = q.type === 'choice' ? 'é€‰æ‹©é¢˜' : q.type === 'truefalse' ? 'åˆ¤æ–­é¢˜' : q.type === 'reading' ? 'ğŸ“– é˜…è¯»ç†è§£é¢˜' : 'å¡«ç©ºé¢˜';
                            let html = `
                            <div class="question-item">
                                <strong>ç¬¬${i+1}é¢˜ (${typeName}) - ${q.knowledgePoint}</strong>
                                <p>${q.content}</p>
                            `;
                            
                            // é˜…è¯»ç†è§£é¢˜æ˜¾ç¤ºæ–‡ç« é¢„è§ˆ
                            if (q.type === 'reading' && q.article) {
                                html += `<div style="background: #f6ffed; padding: 8px; margin: 8px 0; border-radius: 4px; font-size: 12px;">
                                    <strong>é˜…è¯»ææ–™ï¼š</strong>${q.article.substring(0, 100)}...
                                </div>`;
                                if (q.subQuestions && q.subQuestions.length > 0) {
                                    html += `<p style="color: #1890ff; font-size: 12px;">åŒ…å« ${q.subQuestions.length} é“å°é¢˜ï¼ˆé€‰æ‹©é¢˜+ç®€ç­”é¢˜ï¼‰</p>`;
                                }
                            } else if (q.options && q.options.length) {
                                html += `<p>é€‰é¡¹ï¼š${q.options.join(', ')}</p>`;
                            }
                            
                            html += `
                                <p style="color: green">ç­”æ¡ˆï¼š${q.answer}</p>
                                <p style="color: #666; font-size: 12px;">è§£æï¼š${q.explanation}</p>
                            </div>
                            `;
                            return html;
                        }).join('') +
                        `<button class="btn btn-success" onclick="confirmCreateExam('${title}', '${subject}', '${grade}', '${difficulty}', ${count}, ${timeLimit})">ç¡®è®¤åˆ›å»º</button>
                         <button class="btn" onclick="showCreateExam()">é‡æ–°ç”Ÿæˆ</button></div>`;
                } else {
                    previewDiv.innerHTML = '<div class="card"><h3>ç”Ÿæˆå¤±è´¥</h3><p>è¯·é‡è¯•</p></div>';
                }
            } catch (error) {
                console.error('ç”Ÿæˆé¢˜ç›®å¤±è´¥:', error);
                previewDiv.innerHTML = '<div class="card"><h3>ç”Ÿæˆå¤±è´¥</h3><p>ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</p></div>';
            }
        }

        async function confirmCreateExam(title, subject, grade, difficulty, count, timeLimit) {
            const questions = tempQuestions;
            const subjectMap = { math: 'æ•°å­¦', chinese: 'è¯­æ–‡', english: 'è‹±è¯­', physics: 'ç‰©ç†', chemistry: 'åŒ–å­¦' };
            
            try {
                const response = await fetch(`${API_URL}/exams`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        subject: subjectMap[subject] || subject,
                        grade,
                        difficulty,
                        questionCount: count,
                        timeLimit,
                        questions
                    })
                });
                
                if (response.ok) {
                    alert('è€ƒè¯•åˆ›å»ºæˆåŠŸï¼');
                    showTeacherPanel();
                } else {
                    alert('åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥ï¼š' + error.message);
            }
        }

        // åŠ è½½è€ƒè¯•åˆ—è¡¨
        async function loadExamList() {
            try {
                const response = await fetch(`${API_URL}/exams`);
                const exams = await response.json();
                renderExamList(exams);
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“è€ƒè¯•åˆ—è¡¨
        function renderExamList(exams) {
            // åªæ˜¾ç¤ºå½“å‰æ•™å¸ˆç§‘ç›®çš„è€ƒè¯•
            let filteredExams = exams;
            if (currentTeacher && currentTeacher.subject) {
                filteredExams = exams.filter(exam => exam.subject === currentTeacher.subject);
            }

            // å¦‚æœæ•™å¸ˆæœ‰æ‰€æ•™ç­çº§ï¼Œåªæ˜¾ç¤ºå¯¹åº”ç­çº§çš„è€ƒè¯•
            if (currentTeacher && currentTeacher.classes) {
                let teacherClasses = [];
                try {
                    teacherClasses = JSON.parse(currentTeacher.classes);
                } catch (e) {
                    teacherClasses = currentTeacher.classes.split(',').map(c => c.trim());
                }

                console.log('æ•™å¸ˆæ‰€æ•™ç­çº§:', teacherClasses);
                console.log('è¿‡æ»¤å‰è€ƒè¯•æ•°é‡:', filteredExams.length);

                // è¿‡æ»¤ï¼šåªæ˜¾ç¤ºæ²¡æœ‰æŒ‡å®šç­çº§æˆ–ç­çº§åœ¨æ•™å¸ˆæ‰€æ•™ç­çº§åˆ—è¡¨ä¸­çš„è€ƒè¯•
                filteredExams = filteredExams.filter(exam => {
                    if (!exam.exam_class) {
                        console.log('è€ƒè¯•æ— ç­çº§é™åˆ¶:', exam.title);
                        return true; // æ²¡æœ‰æŒ‡å®šç­çº§çš„è€ƒè¯•ï¼Œæ‰€æœ‰æ•™å¸ˆéƒ½èƒ½çœ‹åˆ°
                    }
                    
                    // è§£æè€ƒè¯•ç­çº§ï¼ˆæ”¯æŒå¤šä¸ªç­çº§ï¼Œç”¨"ã€"åˆ†éš”ï¼‰
                    const examClasses = exam.exam_class.split(/[ã€,]/).map(c => c.trim());
                    console.log('è€ƒè¯•ç­çº§:', exam.title, examClasses);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰äº¤é›†ï¼ˆæ•™å¸ˆæ‰€æ•™ç­çº§å’Œè€ƒè¯•ç­çº§çš„äº¤é›†ï¼‰
                    const hasMatch = examClasses.some(cls => teacherClasses.includes(cls));
                    console.log('æ˜¯å¦åŒ¹é…:', hasMatch);
                    return hasMatch;
                });

                console.log('è¿‡æ»¤åè€ƒè¯•æ•°é‡:', filteredExams.length);
            }

            const listDiv = document.getElementById('exam-list');
            if (filteredExams.length === 0) {
                listDiv.innerHTML = `
                    <div class="card">
                        <p>æš‚æ— ${currentTeacher ? currentTeacher.subject : ''}ç§‘ç›®çš„è€ƒè¯•</p>
                        <p style="color: #999; font-size: 14px;">ç‚¹å‡»"åˆ›å»ºæ–°è€ƒè¯•"æŒ‰é’®æ·»åŠ è€ƒè¯•</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = filteredExams.map(exam => `
                <div class="exam-item">
                    <h3>${exam.title}</h3>
                    <p>ç§‘ç›®ï¼š${exam.subject} | å¹´çº§ï¼š${exam.grade} | è€ƒè¯•IDï¼š${exam.id}</p>
                    ${exam.exam_class ? `<p style="color: #1890ff;">ğŸ“‹ è€ƒè¯•ç­çº§ï¼š${exam.exam_class}</p>` : ''}
                    <p>é¢˜ç›®æ•°ï¼š${exam.question_count} | æ—¶é•¿ï¼š${exam.time_limit}åˆ†é’Ÿ</p>
                    <p>çŠ¶æ€ï¼š<span class="status-${exam.status}">${exam.status === 'pending' ? 'å¾…å¼€å§‹' : exam.status === 'active' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'}</span></p>
                    ${exam.status === 'pending' ? `<button class="btn btn-success" onclick="startExam('${exam.id}')">å¼€å§‹è€ƒè¯•</button>` : ''}
                    ${exam.status === 'active' ? `<button class="btn btn-danger" onclick="endExam('${exam.id}')">ç»“æŸè€ƒè¯•</button>` : ''}
                    ${exam.status === 'ended' ? `
                        <button class="btn" onclick="showExamStats('${exam.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                    ` : ''}
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºæŸ¥æ‰¾è€ƒè¯•æ¨¡æ€æ¡†
        function showSearchExamModal() {
            document.getElementById('search-exam-modal').classList.remove('hidden');
            document.getElementById('exam-search-input').focus();
        }

        // å…³é—­æŸ¥æ‰¾è€ƒè¯•æ¨¡æ€æ¡†
        function closeSearchExamModal() {
            document.getElementById('search-exam-modal').classList.add('hidden');
            document.getElementById('search-exam-results').innerHTML = '';
            document.getElementById('exam-search-input').value = '';
        }

        // æœç´¢è€ƒè¯•
        async function searchExams() {
            const searchTerm = document.getElementById('exam-search-input').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('search-exam-results');

            if (!searchTerm) {
                resultsDiv.innerHTML = `
                    <div class="card" style="background: #fff2f0; border-left: 4px solid #ff4d4f;">
                        <p>âš ï¸ è¯·è¾“å…¥æœç´¢å†…å®¹</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${API_URL}/exams`);
                const exams = await response.json();

                // æ ¹æ®åç§°æˆ–IDæœç´¢
                const searchResults = exams.filter(exam => {
                    const matchTitle = exam.title.toLowerCase().includes(searchTerm);
                    const matchId = exam.id.toLowerCase().includes(searchTerm);
                    return matchTitle || matchId;
                });

                // æ˜¾ç¤ºæœç´¢ç»“æœ
                if (searchResults.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="card" style="background: #fff7e6; border-left: 4px solid #faad14;">
                            <p>æœªæ‰¾åˆ°åŒ¹é…çš„è€ƒè¯•</p>
                            <p style="color: #999; font-size: 14px;">æœç´¢å†…å®¹ï¼š"${searchTerm}"</p>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="card" style="background: #e6f7ff; border-left: 4px solid #1890ff;">
                            <p>ğŸ” æœç´¢ç»“æœï¼šæ‰¾åˆ° ${searchResults.length} ä¸ªåŒ¹é…é¡¹</p>
                        </div>
                    ` + searchResults.map(exam => `
                        <div class="exam-item" style="border-left: 4px solid #52c41a; margin-bottom: 12px;">
                            <h4>${exam.title}</h4>
                            <p>ç§‘ç›®ï¼š${exam.subject} | å¹´çº§ï¼š${exam.grade}</p>
                            <p>è€ƒè¯•IDï¼š${exam.id}</p>
                            <p>é¢˜ç›®æ•°ï¼š${exam.question_count} | æ—¶é•¿ï¼š${exam.time_limit}åˆ†é’Ÿ</p>
                            <p>çŠ¶æ€ï¼š<span class="status-${exam.status}">${exam.status === 'pending' ? 'å¾…å¼€å§‹' : exam.status === 'active' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'}</span></p>
                            ${exam.status === 'pending' ? `<button class="btn btn-success" onclick="startExam('${exam.id}'); closeSearchExamModal();">å¼€å§‹è€ƒè¯•</button>` : ''}
                            ${exam.status === 'active' ? `<button class="btn btn-danger" onclick="endExam('${exam.id}'); closeSearchExamModal();">ç»“æŸè€ƒè¯•</button>` : ''}
                            ${exam.status === 'ended' ? `
                                <button class="btn" onclick="showExamStats('${exam.id}'); closeSearchExamModal();">æŸ¥çœ‹è¯¦æƒ…</button>
                            ` : ''}
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                resultsDiv.innerHTML = `
                    <div class="card" style="background: #fff2f0; border-left: 4px solid #ff4d4f;">
                        <p>æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</p>
                    </div>
                `;
            }
        }

        // æ¸…é™¤æœç´¢
        function clearExamSearch() {
            document.getElementById('exam-search-input').value = '';
            document.getElementById('search-exam-results').innerHTML = '';
            document.getElementById('exam-search-input').focus();
        }

        // åŠ è½½è¿›è¡Œä¸­çš„è€ƒè¯•
        async function loadActiveExams() {
            try {
                const response = await fetch(`${API_URL}/exams`);
                const exams = await response.json();
                const activeExams = exams.filter(e => e.status === 'active');
                
                const listDiv = document.getElementById('active-exams');
                if (activeExams.length === 0) {
                    listDiv.innerHTML = '<div class="card"><p>æš‚æ— è¿›è¡Œä¸­çš„è€ƒè¯•</p></div>';
                    return;
                }
                
                listDiv.innerHTML = activeExams.map(exam => `
                    <div class="exam-item">
                        <h3>${exam.title}</h3>
                        <p>ç§‘ç›®ï¼š${exam.subject} | å¹´çº§ï¼š${exam.grade}</p>
                        <p>é¢˜ç›®æ•°ï¼š${exam.question_count} | æ—¶é•¿ï¼š${exam.time_limit}åˆ†é’Ÿ</p>
                        <button class="btn btn-success" onclick="joinExam('${exam.id}', '${exam.title}')">è¿›å…¥è€ƒè¯•</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
            }
        }

        // å¾…å¼€å§‹çš„è€ƒè¯•IDå’Œé€‰ä¸­çš„ç­çº§
        let pendingStartExamId = null;

        // å¼€å§‹è€ƒè¯• - å…ˆé€‰æ‹©ç­çº§
        function startExam(id) {
            pendingStartExamId = id;

            // è·å–æ•™å¸ˆæ‰€æ•™ç­çº§
            if (!currentTeacher || !currentTeacher.classes) {
                alert('æ— æ³•è·å–æ•™å¸ˆç­çº§ä¿¡æ¯');
                return;
            }

            let teacherClasses = [];
            try {
                teacherClasses = JSON.parse(currentTeacher.classes);
            } catch (e) {
                teacherClasses = currentTeacher.classes.split(',').map(c => c.trim());
            }

            if (teacherClasses.length === 0) {
                alert('æ‚¨æ²¡æœ‰è®¾ç½®æ‰€æ•™ç­çº§ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
                return;
            }

            // æ˜¾ç¤ºç­çº§é€‰æ‹©æ¨¡æ€æ¡† - æŒ‰å¹´çº§åˆ†ç»„æ˜¾ç¤º
            const classOptionsDiv = document.getElementById('exam-class-options');

            // æŒ‰å¹´çº§åˆ†ç»„
            const gradeGroups = {
                'é«˜ä¸€': [],
                'é«˜äºŒ': [],
                'é«˜ä¸‰': []
            };

            // å¤„ç†ç­çº§æ•°æ®ï¼ˆå…¼å®¹æ—§æ ¼å¼å¦‚"1ç­"å’Œæ–°æ ¼å¼å¦‚"é«˜ä¸€1ç­"ï¼‰
            teacherClasses.forEach(cls => {
                if (cls.startsWith('é«˜ä¸€')) gradeGroups['é«˜ä¸€'].push(cls);
                else if (cls.startsWith('é«˜äºŒ')) gradeGroups['é«˜äºŒ'].push(cls);
                else if (cls.startsWith('é«˜ä¸‰')) gradeGroups['é«˜ä¸‰'].push(cls);
                else {
                    // æ—§æ ¼å¼ï¼ˆå¦‚"1ç­"ï¼‰ï¼Œé»˜è®¤å½’å…¥é«˜ä¸€
                    gradeGroups['é«˜ä¸€'].push('é«˜ä¸€' + cls);
                }
            });

            const gradeColors = {
                'é«˜ä¸€': '#1890ff',
                'é«˜äºŒ': '#52c41a',
                'é«˜ä¸‰': '#faad14'
            };

            let html = '';
            Object.keys(gradeGroups).forEach(grade => {
                if (gradeGroups[grade].length > 0) {
                    html += `
                        <div style="margin-bottom: 16px;">
                            <strong style="color: ${gradeColors[grade]};">${grade}</strong>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px;">
                                ${gradeGroups[grade].map(cls => `
                                    <label style="display: flex; align-items: center; padding: 8px; background: #f5f5f5; border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" name="exam-class" value="${cls}" style="width: auto; margin-right: 6px;">
                                        <span style="font-size: 14px;">${cls.replace(grade, '')}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            // æ·»åŠ å…¨é€‰æŒ‰é’®
            html += `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e8e8e8;">
                    <button class="btn" onclick="selectAllExamClasses()" style="margin-right: 8px;">å…¨é€‰</button>
                    <button class="btn" onclick="clearAllExamClasses()">æ¸…ç©º</button>
                </div>
            `;

            classOptionsDiv.innerHTML = html;
            document.getElementById('select-exam-class-modal').classList.remove('hidden');
        }

        // å…¨é€‰è€ƒè¯•ç­çº§
        function selectAllExamClasses() {
            document.querySelectorAll('input[name="exam-class"]').forEach(cb => cb.checked = true);
        }

        // æ¸…ç©ºè€ƒè¯•ç­çº§é€‰æ‹©
        function clearAllExamClasses() {
            document.querySelectorAll('input[name="exam-class"]').forEach(cb => cb.checked = false);
        }

        // ç¡®è®¤å¼€å§‹è€ƒè¯•ï¼ˆå¸¦ç­çº§ï¼‰
        async function confirmStartExamWithClass() {
            const selectedClasses = document.querySelectorAll('input[name="exam-class"]:checked');

            if (selectedClasses.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç­çº§');
                return;
            }

            const examClasses = Array.from(selectedClasses).map(cb => cb.value);
            const examClassStr = examClasses.join('ã€');

            try {
                const response = await fetch(`${API_URL}/exams/${pendingStartExamId}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ examClass: examClassStr })
                });

                if (response.ok) {
                    alert(`è€ƒè¯•å·²å¼€å§‹\nè€ƒè¯•ç­çº§ï¼š${examClassStr}`);
                    closeSelectExamClassModal();
                    loadExamList();
                } else {
                    alert('æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                console.error('å¼€å§‹è€ƒè¯•å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥');
            }
        }

        // å…³é—­é€‰æ‹©ç­çº§æ¨¡æ€æ¡†
        function closeSelectExamClassModal() {
            document.getElementById('select-exam-class-modal').classList.add('hidden');
            pendingStartExamId = null;
        }

        async function endExam(id) {
            if (!confirm('ç¡®è®¤ç»“æŸè€ƒè¯•ï¼Ÿ')) return;
            try {
                await fetch(`${API_URL}/exams/${id}/end`, { method: 'POST' });
                alert('è€ƒè¯•å·²ç»“æŸ');
                loadExamList();
            } catch (error) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        // å½“å‰è¦åŠ å…¥çš„è€ƒè¯•IDå’Œè€ƒè¯•ç­çº§
        let pendingExamId = null;
        let pendingExamClass = null;

        // åŠ å…¥è€ƒè¯•
        async function joinExam(examId, title) {
            pendingExamId = examId;

            // è·å–è€ƒè¯•ä¿¡æ¯ï¼ŒåŒ…æ‹¬è€ƒè¯•ç­çº§
            try {
                const response = await fetch(`${API_URL}/exams/${examId}`);
                const examData = await response.json();
                pendingExamClass = examData.exam_class;

                let examInfoHtml = `<p><strong>è€ƒè¯•ï¼š</strong>${title}</p>`;
                if (pendingExamClass) {
                    examInfoHtml += `<p style="color: #1890ff; margin-top: 8px;"><strong>è€ƒè¯•ç­çº§ï¼š</strong>${pendingExamClass}</p>`;
                    examInfoHtml += `<p style="color: #ff4d4f; font-size: 12px; margin-top: 4px;">âš ï¸ åªæœ‰${pendingExamClass}çš„å­¦ç”Ÿå¯ä»¥å‚åŠ </p>`;
                }
                document.getElementById('join-exam-info').innerHTML = examInfoHtml;
            } catch (error) {
                document.getElementById('join-exam-info').innerHTML = `<p><strong>è€ƒè¯•ï¼š</strong>${title}</p>`;
            }

            document.getElementById('student-info-modal').classList.remove('hidden');
        }

        function closeStudentModal() {
            document.getElementById('student-info-modal').classList.add('hidden');
            pendingExamId = null;
            pendingExamClass = null;
        }

        // æ˜¾ç¤ºè€ƒè¯•ç»Ÿè®¡è¯¦æƒ…
        async function showExamStats(examId) {
            try {
                // å…ˆæ£€æŸ¥é˜…å·çŠ¶æ€
                const progressResponse = await fetch(`${API_URL}/exams/${examId}/grading-progress`);
                const progressData = await progressResponse.json();
                
                if (!progressData.isComplete && progressData.total > 0) {
                    // é˜…å·æœªå®Œæˆï¼Œæ˜¾ç¤ºæç¤º
                    const contentDiv = document.getElementById('exam-stats-content');
                    contentDiv.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px; background: #fff7e6;">
                            <h2 style="color: #faad14; margin-bottom: 20px;">â³ é˜…å·å·¥ä½œæ­£åœ¨è¿›è¡Œä¸­</h2>
                            <p style="font-size: 18px; margin-bottom: 20px;">è¯·ç¨åå†è¯•ï¼Œç­‰å¾…æ‰€æœ‰æ•™å¸ˆå®Œæˆä¸»è§‚é¢˜æ‰¹æ”¹</p>
                            <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h3 style="margin-bottom: 16px;">é˜…å·è¿›åº¦</h3>
                                <div style="font-size: 48px; color: #1890ff; margin-bottom: 10px;">
                                    ${progressData.completed} <span style="font-size: 24px; color: #999;">/ ${progressData.total}</span>
                                </div>
                                <div style="width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                                    <div style="width: ${(progressData.completed / progressData.total * 100)}%; height: 100%; background: #52c41a; transition: width 0.3s;"></div>
                                </div>
                                <p style="margin-top: 10px; color: #666;">å·²å®Œæˆ ${(progressData.completed / progressData.total * 100).toFixed(1)}%</p>
                            </div>
                            <p style="color: #999; font-size: 14px;">è¿˜å‰© ${progressData.pending} é“é¢˜å¾…æ‰¹æ”¹</p>
                        </div>
                    `;
                    document.getElementById('exam-stats-modal').classList.remove('hidden');
                    return;
                }
                
                const response = await fetch(`${API_URL}/exams/${examId}/statistics`);
                const data = await response.json();
                
                const contentDiv = document.getElementById('exam-stats-content');
                contentDiv.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3>${data.exam.title}</h3>
                        <p>ç§‘ç›®ï¼š${data.exam.subject} | å¹´çº§ï¼š${data.exam.grade} | éš¾åº¦ï¼š${data.exam.difficulty}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div class="card" style="text-align: center;">
                            <h4 style="color: #1890ff; font-size: 32px; margin: 0;">${data.totalStudents}</h4>
                            <p style="margin: 8px 0 0 0; color: #666;">å‚è€ƒäººæ•°</p>
                        </div>
                        <div class="card" style="text-align: center;">
                            <h4 style="color: #52c41a; font-size: 32px; margin: 0;">${data.avgScore}</h4>
                            <p style="margin: 8px 0 0 0; color: #666;">å¹³å‡åˆ†</p>
                        </div>
                        <div class="card" style="text-align: center;">
                            <h4 style="color: #faad14; font-size: 32px; margin: 0;">${data.maxScore}</h4>
                            <p style="margin: 8px 0 0 0; color: #666;">æœ€é«˜åˆ†</p>
                        </div>
                        <div class="card" style="text-align: center;">
                            <h4 style="color: #ff4d4f; font-size: 32px; margin: 0;">${data.minScore}</h4>
                            <p style="margin: 8px 0 0 0; color: #666;">æœ€ä½åˆ†</p>
                        </div>
                    </div>
                    
                    <h3>ğŸ“Š ç­çº§ç»Ÿè®¡</h3>
                    ${data.classStats && data.classStats.length > 0 ? `
                        <div style="margin-bottom: 24px;">
                            ${data.classStats.map((cls, idx) => `
                                <div class="card" style="margin-bottom: 16px; border-left: 4px solid ${['#1890ff', '#52c41a', '#faad14', '#ff4d4f', '#722ed1'][idx % 5]};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <h4 style="margin: 0; color: ${['#1890ff', '#52c41a', '#faad14', '#ff4d4f', '#722ed1'][idx % 5]};">${cls.className}</h4>
                                        <span style="background: #f0f0f0; padding: 4px 12px; border-radius: 12px; font-size: 14px;">${cls.studentCount}äºº</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 12px;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 24px; font-weight: bold; color: #1890ff;">${cls.avgScore}</div>
                                            <div style="font-size: 12px; color: #999;">å¹³å‡åˆ†</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 24px; font-weight: bold; color: #52c41a;">${cls.maxScore}</div>
                                            <div style="font-size: 12px; color: #999;">æœ€é«˜åˆ†</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 24px; font-weight: bold; color: #faad14;">${cls.minScore === 9999 ? 0 : cls.minScore}</div>
                                            <div style="font-size: 12px; color: #999;">æœ€ä½åˆ†</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 24px; font-weight: bold; color: #ff4d4f;">${cls.students && cls.students.length > 0 ? cls.students[0].score : 0}</div>
                                            <div style="font-size: 12px; color: #999;">ç­çº§ç¬¬ä¸€</div>
                                        </div>
                                    </div>
                                    <details style="margin-top: 12px;">
                                        <summary style="cursor: pointer; color: #1890ff; font-size: 14px;">æŸ¥çœ‹ç­çº§å­¦ç”Ÿåå• (${cls.students ? cls.students.length : 0}äºº)</summary>
                                        <div style="margin-top: 12px; max-height: 200px; overflow-y: auto;">
                                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                                <thead>
                                                    <tr style="background: #f5f5f5;">
                                                        <th style="padding: 8px; border: 1px solid #e8e8e8;">ç­çº§æ’å</th>
                                                        <th style="padding: 8px; border: 1px solid #e8e8e8;">å§“å</th>
                                                        <th style="padding: 8px; border: 1px solid #e8e8e8;">å­¦å·</th>
                                                        <th style="padding: 8px; border: 1px solid #e8e8e8;">å¾—åˆ†</th>
                                                        <th style="padding: 8px; border: 1px solid #e8e8e8;">æ“ä½œ</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${cls.students ? cls.students.map((s, i) => `
                                                        <tr>
                                                            <td style="padding: 8px; border: 1px solid #e8e8e8; text-align: center;">${i + 1}</td>
                                                            <td style="padding: 8px; border: 1px solid #e8e8e8;">${s.name}</td>
                                                            <td style="padding: 8px; border: 1px solid #e8e8e8;">${s.studentId}</td>
                                                            <td style="padding: 8px; border: 1px solid #e8e8e8; text-align: center; font-weight: bold; color: ${s.score >= 80 ? '#52c41a' : s.score >= 60 ? '#faad14' : '#ff4d4f'};">${s.score}</td>
                                                            <td style="padding: 8px; border: 1px solid #e8e8e8; text-align: center;">
                                                                <button class="btn" style="padding: 4px 8px; font-size: 12px;" onclick="viewStudentPaper('${examId}', '${s.studentId}', '${s.name}')">ğŸ“„ åŸå·</button>
                                                            </td>
                                                        </tr>
                                                    `).join('') : ''}
                                                </tbody>
                                            </table>
                                        </div>
                                    </details>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #999; margin-bottom: 24px;">æš‚æ— ç­çº§æ•°æ®</p>'}
                    
                    <h3>ğŸ† æ€»æˆç»©æ’å</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 24px;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">æ’å</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">å§“å</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">å­¦å·</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">ç­çº§</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">å¾—åˆ†</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">æ­£ç¡®é¢˜æ•°</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.ranking.map((s, i) => `
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8; text-align: center;">
                                        ${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : s.rank}
                                    </td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8;">${s.name}</td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8;">${s.studentId}</td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8;">${s.className || '-'}</td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8; text-align: center; font-weight: bold; color: ${s.score >= 80 ? '#52c41a' : s.score >= 60 ? '#faad14' : '#ff4d4f'};">${s.score}</td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8; text-align: center;">${s.correctCount}/${s.totalAnswered}</td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8; text-align: center;">
                                        <button class="btn" onclick="viewStudentPaper('${examId}', '${s.studentId}', '${s.name}')">ğŸ“„ æŸ¥çœ‹åŸå·</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <h3>é¢˜ç›®åˆ†æ</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">é¢˜å·</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">çŸ¥è¯†ç‚¹</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">é¢˜å‹</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">æ»¡åˆ†</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">ç­”é¢˜äººæ•°</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">æ­£ç¡®äººæ•°</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">æ­£ç¡®ç‡</th>
                                <th style="padding: 12px; border: 1px solid #e8e8e8;">å¹³å‡å¾—åˆ†</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.questionStats.map((q, i) => `
                                <tr>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8; text-align: center;">${i + 1}</td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8;">${q.knowledgePoint || '-'}</td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8;">${q.type === 'choice' ? 'é€‰æ‹©é¢˜' : q.type === 'truefalse' ? 'åˆ¤æ–­é¢˜' : 'å¡«ç©ºé¢˜'}</td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8; text-align: center;">${q.fullScore}</td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8; text-align: center;">${q.totalAnswers}</td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8; text-align: center;">${q.correctCount}</td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8; text-align: center; color: ${q.correctRate >= 80 ? '#52c41a' : q.correctRate >= 60 ? '#faad14' : '#ff4d4f'}; font-weight: bold;">${q.correctRate}%</td>
                                    <td style="padding: 12px; border: 1px solid #e8e8e8; text-align: center;">${q.avgScore}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('exam-stats-modal').classList.remove('hidden');
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
                alert('åŠ è½½è€ƒè¯•ç»Ÿè®¡å¤±è´¥');
            }
        }

        function closeExamStatsModal() {
            document.getElementById('exam-stats-modal').classList.add('hidden');
        }

        // æŸ¥çœ‹å­¦ç”ŸåŸå·
        async function viewStudentPaper(examId, studentId, studentName) {
            try {
                // è·å–å­¦ç”Ÿç­”æ¡ˆè¯¦æƒ…
                const response = await fetch(`${API_URL}/exams/${examId}/student-answers/${studentId}`);
                const answers = await response.json();
                
                if (!answers || answers.length === 0) {
                    alert('æœªæ‰¾åˆ°è¯¥å­¦ç”Ÿçš„ç­”é¢˜è®°å½•');
                    return;
                }
                
                // è®¡ç®—æ€»åˆ†
                let totalScore = 0;
                let fullScore = 0;
                answers.forEach(a => {
                    if (a.score !== null && a.score !== undefined) {
                        totalScore += a.score;
                    }
                    fullScore += a.full_score || 0;
                });
                
                // æ˜¾ç¤ºå­¦ç”Ÿä¿¡æ¯
                document.getElementById('student-paper-info').innerHTML = `
                    <h3>å­¦ç”Ÿï¼š${studentName} (${studentId})</h3>
                    <p style="font-size: 18px; margin-top: 10px;">
                        <strong>æ€»åˆ†ï¼š${totalScore}/${fullScore}åˆ†</strong>
                        <span style="color: ${totalScore >= fullScore * 0.8 ? '#52c41a' : totalScore >= fullScore * 0.6 ? '#faad14' : '#ff4d4f'}; margin-left: 10px;">
                            (${(totalScore / fullScore * 100).toFixed(1)}%)
                        </span>
                    </p>
                `;
                
                // æ˜¾ç¤ºç­”é¢˜è¯¦æƒ…
                const contentDiv = document.getElementById('student-paper-content');
                contentDiv.innerHTML = answers.map((a, index) => {
                    const typeName = a.type === 'choice' ? 'é€‰æ‹©é¢˜' : 
                                    a.type === 'truefalse' ? 'åˆ¤æ–­é¢˜' : 
                                    a.type === 'fillblank' ? 'å¡«ç©ºé¢˜' : 
                                    a.type === 'reading' ? 'ğŸ“– é˜…è¯»ç†è§£é¢˜' : 'è§£ç­”é¢˜';
                    
                    const isCorrect = a.score === a.full_score;
                    const isPartial = a.score > 0 && a.score < a.full_score;
                    const statusColor = isCorrect ? '#52c41a' : isPartial ? '#faad14' : '#ff4d4f';
                    const statusText = isCorrect ? 'âœ… æ­£ç¡®' : isPartial ? 'âš ï¸ éƒ¨åˆ†æ­£ç¡®' : 'âŒ é”™è¯¯';
                    
                    return `
                        <div class="question-item" style="border-left: 4px solid ${statusColor}; margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>ç¬¬${index + 1}é¢˜ ã€${typeName}ã€‘</strong>
                                <span style="color: ${statusColor}; font-weight: bold;">
                                    ${statusText} (${a.score !== null ? a.score : 0}/${a.full_score}åˆ†)
                                </span>
                            </div>
                            <div style="background: #f9f9f9; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                                <p><strong>é¢˜ç›®ï¼š</strong>${a.content}</p>
                                ${a.options && a.options.length > 0 ? `
                                    <p style="margin-top: 8px;"><strong>é€‰é¡¹ï¼š</strong>${Array.isArray(a.options) ? a.options.join(' | ') : a.options}</p>
                                ` : ''}
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div style="background: #e6f7ff; padding: 10px; border-radius: 6px;">
                                    <p style="color: #1890ff; font-weight: bold;">å­¦ç”Ÿç­”æ¡ˆ</p>
                                    <p>${a.answer || 'æœªä½œç­”'}</p>
                                </div>
                                <div style="background: #f6ffed; padding: 10px; border-radius: 6px;">
                                    <p style="color: #52c41a; font-weight: bold;">æ­£ç¡®ç­”æ¡ˆ</p>
                                    <p>${a.correct_answer || 'è§è§£æ'}</p>
                                </div>
                            </div>
                            ${a.teacher_comment ? `
                                <div style="background: #fff7e6; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                    <p style="color: #faad14; font-weight: bold;">æ•™å¸ˆè¯„è¯­</p>
                                    <p>${a.teacher_comment}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
                document.getElementById('student-paper-modal').classList.remove('hidden');
            } catch (error) {
                console.error('åŠ è½½å­¦ç”ŸåŸå·å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å…³é—­å­¦ç”ŸåŸå·æ¨¡æ€æ¡†
        function closeStudentPaperModal() {
            document.getElementById('student-paper-modal').classList.add('hidden');
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        async function clearAllData() {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰è€ƒè¯•ã€é¢˜ç›®å’Œå­¦ç”Ÿç­”é¢˜è®°å½•ï¼\n\nç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                return;
            }
            
            if (!confirm('å†æ¬¡ç¡®è®¤ï¼šæ‚¨çœŸçš„è¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/clear-all`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ï¼');
                    loadExamList(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('æ¸…é™¤å¤±è´¥ï¼š' + data.error);
                }
            } catch (error) {
                console.error('æ¸…é™¤æ•°æ®å¤±è´¥:', error);
                alert('æ¸…é™¤æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function confirmJoinExam() {
            const name = document.getElementById('student-name-input').value.trim();
            const id = document.getElementById('student-id-input').value.trim();
            const className = document.getElementById('student-class-input').value.trim();

            if (!name || !id || !className) {
                alert('è¯·å¡«å†™å§“åã€å­¦å·å’Œç­çº§');
                return;
            }

            // éªŒè¯ç­çº§æ˜¯å¦ç¬¦åˆè€ƒè¯•è¦æ±‚ï¼ˆæ”¯æŒå¤šä¸ªç­çº§ï¼Œç”¨"ã€"åˆ†éš”ï¼‰
            if (pendingExamClass) {
                // æ ‡å‡†åŒ–ç­çº§åç§°è¿›è¡Œæ¯”è¾ƒï¼ˆå»é™¤ç©ºæ ¼ï¼Œç»Ÿä¸€æ ¼å¼ï¼‰
                const normalizedInputClass = className.replace(/\s+/g, '');

                // è§£æè€ƒè¯•ç­çº§ï¼ˆæ”¯æŒå¤šä¸ªç­çº§ï¼Œç”¨"ã€"æˆ–","åˆ†éš”ï¼‰
                const examClasses = pendingExamClass.split(/[ã€,]/).map(c => c.trim().replace(/\s+/g, ''));

                // æ£€æŸ¥è¾“å…¥çš„ç­çº§æ˜¯å¦åœ¨è€ƒè¯•ç­çº§åˆ—è¡¨ä¸­
                if (!examClasses.includes(normalizedInputClass)) {
                    alert(`ç­çº§ä¸åŒ¹é…ï¼\n\næ‚¨è¾“å…¥çš„ç­çº§ï¼š${className}\nè€ƒè¯•æŒ‡å®šç­çº§ï¼š${pendingExamClass}\n\nåªæœ‰ä»¥ä¸Šç­çº§çš„å­¦ç”Ÿå¯ä»¥å‚åŠ æœ¬æ¬¡è€ƒè¯•ã€‚`);
                    return;
                }
            }

            studentInfo.name = name;
            studentInfo.id = id;
            studentInfo.className = className;

            document.getElementById('student-info-modal').classList.add('hidden');

            if (pendingExamId) {
                startTakingExam(pendingExamId);
                pendingExamId = null;
                pendingExamClass = null;
            }
        }

        // æ˜¾ç¤ºè¯•å·åº“
        function showPaperLibrary() {
            hideAll();
            document.getElementById('paper-library').classList.remove('hidden');
            loadPaperLibrary();
            loadPaperStats();
        }

        // åŠ è½½è¯•å·åº“ç»Ÿè®¡
        async function loadPaperStats() {
            try {
                const response = await fetch(`${API_URL}/paper-stats`);
                const stats = await response.json();
                
                const statsDiv = document.getElementById('paper-stats');
                statsDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                        <div class="card" style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h3 style="font-size: 36px; margin: 0;">${stats.totalPapers || 0}</h3>
                            <p style="margin: 8px 0 0 0;">æ€»è¯•å·æ•°</p>
                        </div>
                        <div class="card" style="text-align: center; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                            <h3 style="font-size: 36px; margin: 0;">${stats.provinceCount || 0}</h3>
                            <p style="margin: 8px 0 0 0;">è¦†ç›–çœä»½</p>
                        </div>
                        <div class="card" style="text-align: center; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                            <h3 style="font-size: 36px; margin: 0;">${stats.subjectCount || 0}</h3>
                            <p style="margin: 8px 0 0 0;">ç§‘ç›®ç§ç±»</p>
                        </div>
                        <div class="card" style="text-align: center; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                            <h3 style="font-size: 36px; margin: 0;">${stats.yearCount || 0}</h3>
                            <p style="margin: 8px 0 0 0;">å¹´ä»½è·¨åº¦</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // ========== æ‰‹åŠ¨æ·»åŠ è¯•å·åŠŸèƒ½ ==========
        let currentAddingPaper = null;
        let paperQuestions = [];

        // æ˜¾ç¤ºæ·»åŠ è¯•å·é¢æ¿
        function showAddPaperPanel() {
            hideAll();
            document.getElementById('add-paper-panel').classList.remove('hidden');
            currentAddingPaper = null;
            paperQuestions = [];
        }



        // ä¿å­˜è¯•å·åŸºæœ¬ä¿¡æ¯
        function savePaperInfo() {
            const title = document.getElementById('paper-title').value.trim();
            const examType = document.getElementById('paper-exam-type').value;
            const province = document.getElementById('paper-province').value.trim();
            const subject = document.getElementById('paper-subject').value;
            const year = parseInt(document.getElementById('paper-year').value);
            const grade = document.getElementById('paper-grade').value;
            const time = parseInt(document.getElementById('paper-time').value);

            if (!title) {
                alert('è¯·è¾“å…¥è¯•å·æ ‡é¢˜');
                return;
            }

            currentAddingPaper = {
                title,
                examType,
                province: province || 'æœªçŸ¥',
                subject,
                year,
                grade,
                examTime: time
            };

            // æ˜¾ç¤ºæ·»åŠ é¢˜ç›®é¢æ¿
            hideAll();
            document.getElementById('add-questions-panel').classList.remove('hidden');
            document.getElementById('current-paper-info').innerHTML = 
                `<strong>å½“å‰è¯•å·ï¼š</strong>${title}ï¼ˆ${subject} ${year}å¹´ï¼‰`;
            
            // æ¸…ç©ºé¢˜ç›®è¾“å…¥
            clearQuestionInputs();
            updateQuestionsPreview();
        }

        // åˆ‡æ¢é¢˜ç›®ç±»å‹æ—¶æ˜¾ç¤º/éšè—é€‰é¡¹è¾“å…¥
        function toggleQuestionOptions() {
            const type = document.getElementById('question-type').value;
            const normalSection = document.getElementById('normal-question-section');
            const readingSection = document.getElementById('reading-section');
            const answerChoice = document.getElementById('answer-choice');
            const answerTrueFalse = document.getElementById('answer-truefalse');
            const answerText = document.getElementById('answer-text');
            
            // éšè—æ‰€æœ‰
            normalSection.style.display = 'none';
            readingSection.style.display = 'none';
            answerChoice.style.display = 'none';
            answerTrueFalse.style.display = 'none';
            answerText.style.display = 'none';
            
            if (type === 'reading') {
                // é˜…è¯»ç†è§£é¢˜ - æ˜¾ç¤ºä¸“ç”¨ç•Œé¢
                readingSection.style.display = 'block';
                // é‡ç½®é˜…è¯»ç†è§£çŠ¶æ€
                document.getElementById('reading-step1').style.display = 'block';
                document.getElementById('reading-step2').style.display = 'none';
            } else {
                // æ™®é€šé¢˜ç›®
                normalSection.style.display = 'block';
                
                if (type === 'choice') {
                    answerChoice.style.display = 'block';
                } else if (type === 'truefalse') {
                    answerTrueFalse.style.display = 'block';
                } else if (type === 'fillblank' || type === 'subjective') {
                    answerText.style.display = 'block';
                }
            }
        }
        
        // åˆ‡æ¢é˜…è¯»ç†è§£å­é¢˜ç›®ç±»å‹
        function toggleReadingSubOptions() {
            const subtype = document.getElementById('reading-sub-type').value;
            const optionsDiv = document.getElementById('reading-sub-options-div');
            const answerChoice = document.getElementById('reading-sub-answer-choice');
            const answerText = document.getElementById('reading-sub-answer-text');
            
            if (subtype === 'choice') {
                optionsDiv.style.display = 'block';
                answerChoice.style.display = 'block';
                answerText.style.display = 'none';
            } else {
                // ç®€ç­”é¢˜
                optionsDiv.style.display = 'none';
                answerChoice.style.display = 'none';
                answerText.style.display = 'block';
            }
        }

        // æ¸…ç©ºé¢˜ç›®è¾“å…¥æ¡†
        function clearQuestionInputs() {
            // æ™®é€šé¢˜ç›®è¾“å…¥
            document.getElementById('question-content').value = '';
            document.getElementById('question-options').value = '';
            document.getElementById('question-answer-choice').value = '';
            document.getElementById('question-answer-truefalse').value = '';
            document.getElementById('question-answer-text').value = '';
            document.getElementById('question-explanation').value = '';
            document.getElementById('question-knowledge').value = '';
            document.getElementById('question-score').value = '5';
            document.getElementById('question-type').value = 'choice';
            
            // é˜…è¯»ç†è§£é¢˜è¾“å…¥
            document.getElementById('reading-article-content').value = '';
            document.getElementById('reading-sub-content').value = '';
            document.getElementById('reading-sub-options').value = '';
            document.getElementById('reading-sub-answer-select').value = '';
            document.getElementById('reading-sub-answer-input').value = '';
            document.getElementById('reading-sub-explanation').value = '';
            document.getElementById('reading-sub-score').value = '5';
            document.getElementById('reading-sub-type').value = 'choice';
            
            // é‡ç½®é˜…è¯»ç†è§£ç•Œé¢æ­¥éª¤
            document.getElementById('reading-step1').style.display = 'block';
            document.getElementById('reading-step2').style.display = 'none';
            document.getElementById('reading-subquestions-list').innerHTML = '';
            
            // é‡ç½®é˜…è¯»ç†è§£ä¸´æ—¶æ•°æ®
            currentReadingArticle = '';
            currentReadingQuestions = [];
            toggleQuestionOptions();
        }

        // æ·»åŠ é¢˜ç›®åˆ°å½“å‰è¯•å·
        function addQuestionToPaper() {
            const type = document.getElementById('question-type').value;
            const content = document.getElementById('question-content').value.trim();
            const optionsText = document.getElementById('question-options').value.trim();
            const explanation = document.getElementById('question-explanation').value.trim();
            const knowledge = document.getElementById('question-knowledge').value.trim();
            const score = parseInt(document.getElementById('question-score').value);
            
            // å¤„ç†é˜…è¯»ç†è§£é¢˜
            if (type === 'reading') {
                addReadingQuestion();
                return;
            }
            
            // æ ¹æ®é¢˜ç›®ç±»å‹è·å–ç­”æ¡ˆ
            let answer = '';
            if (type === 'choice') {
                answer = document.getElementById('question-answer-choice').value;
            } else if (type === 'truefalse') {
                answer = document.getElementById('question-answer-truefalse').value;
            } else {
                answer = document.getElementById('question-answer-text').value.trim();
            }

            if (!content) {
                alert('è¯·è¾“å…¥é¢˜ç›®å†…å®¹');
                return;
            }
            if (!answer) {
                alert('è¯·é€‰æ‹©æˆ–è¾“å…¥æ­£ç¡®ç­”æ¡ˆ');
                return;
            }

            let options = [];
            if (type === 'choice') {
                options = optionsText.split('\n').filter(o => o.trim()).map(o => o.trim());
                if (options.length < 2) {
                    alert('é€‰æ‹©é¢˜è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹');
                    return;
                }
            } else if (type === 'truefalse') {
                options = ['æ­£ç¡®', 'é”™è¯¯'];
            }

            const question = {
                type,
                content,
                options,
                answer,
                explanation: explanation || 'æš‚æ— è§£æ',
                knowledgePoint: knowledge || 'ç»¼åˆçŸ¥è¯†',
                score,
                question_order: paperQuestions.length + 1
            };

            paperQuestions.push(question);
            updateQuestionsPreview();
            clearQuestionInputs();
            
            alert(`âœ… ç¬¬${paperQuestions.length}é¢˜æ·»åŠ æˆåŠŸï¼ç»§ç»­æ·»åŠ ä¸‹ä¸€é¢˜æˆ–ç‚¹å‡»"å®Œæˆæ·»åŠ "`);
        }
        
        // å½“å‰é˜…è¯»ç†è§£æ–‡ç« ï¼ˆä¸´æ—¶å­˜å‚¨ï¼‰
        let currentReadingArticle = '';
        let currentReadingQuestions = [];
        
        // ç¡®è®¤é˜…è¯»æ–‡ç« ï¼Œè¿›å…¥æ·»åŠ å°é¢˜æ­¥éª¤
        function confirmReadingArticle() {
            const article = document.getElementById('reading-article-content').value.trim();
            if (!article) {
                alert('è¯·è¾“å…¥é˜…è¯»æ–‡ç« ');
                return;
            }
            
            currentReadingArticle = article;
            
            // æ˜¾ç¤ºæ–‡ç« é¢„è§ˆ
            document.getElementById('reading-article-preview').textContent = article.substring(0, 300) + (article.length > 300 ? '...' : '');
            
            // åˆ‡æ¢åˆ°æ­¥éª¤2
            document.getElementById('reading-step1').style.display = 'none';
            document.getElementById('reading-step2').style.display = 'block';
            
            // æ›´æ–°å°é¢˜ç¼–å·
            updateReadingSubQuestionNumber();
            
            // åˆå§‹åŒ–å­é¢˜ç›®åˆ—è¡¨
            updateReadingSubQuestionsList();
        }
        
        // æ›´æ–°å°é¢˜ç¼–å·æ˜¾ç¤º
        function updateReadingSubQuestionNumber() {
            document.getElementById('reading-subquestion-number').textContent = currentReadingQuestions.length + 1;
        }
        
        // æ›´æ–°å­é¢˜ç›®åˆ—è¡¨æ˜¾ç¤º
        function updateReadingSubQuestionsList() {
            const listDiv = document.getElementById('reading-subquestions-list');
            
            if (currentReadingQuestions.length === 0) {
                listDiv.innerHTML = '<div class="card" style="background: #fff7e6;"><p>è¿˜æ²¡æœ‰æ·»åŠ å°é¢˜ï¼Œè¯·æ·»åŠ ç¬¬ä¸€é“å°é¢˜</p></div>';
                return;
            }
            
            const totalScore = currentReadingQuestions.reduce((sum, q) => sum + q.score, 0);
            
            let html = `
                <div class="card" style="background: #f6ffed; border: 1px solid #52c41a;">
                    <h4>ğŸ“‹ å·²æ·»åŠ çš„å°é¢˜ï¼ˆå…±${currentReadingQuestions.length}é“ï¼Œ${totalScore}åˆ†ï¼‰</h4>
            `;
            
            currentReadingQuestions.forEach((q, i) => {
                html += `
                    <div style="margin: 8px 0; padding: 12px; background: white; border-radius: 4px; border-left: 4px solid ${q.type === 'choice' ? '#1890ff' : '#52c41a'};">
                        <div style="font-weight: bold; margin-bottom: 4px;">
                            ç¬¬${i + 1}å°é¢˜ [${q.type === 'choice' ? 'é€‰æ‹©é¢˜' : 'ç®€ç­”é¢˜'}] ${q.score}åˆ†
                            <button class="btn btn-danger" style="padding: 2px 8px; font-size: 12px; margin-left: 8px;" onclick="removeReadingSubQuestion(${i})">åˆ é™¤</button>
                        </div>
                        <div style="margin-bottom: 4px;">${q.content.substring(0, 100)}${q.content.length > 100 ? '...' : ''}</div>
                        <div style="color: #1890ff; font-size: 12px;">ç­”æ¡ˆï¼š${q.answer}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            listDiv.innerHTML = html;
        }
        
        // åˆ é™¤å­é¢˜ç›®
        function removeReadingSubQuestion(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™é“å°é¢˜å—ï¼Ÿ')) {
                currentReadingQuestions.splice(index, 1);
                // é‡æ–°ç¼–å·
                currentReadingQuestions.forEach((q, i) => {
                    q.subQuestionNumber = i + 1;
                });
                updateReadingSubQuestionsList();
                updateReadingSubQuestionNumber();
            }
        }
        
        // æ·»åŠ å­é¢˜ç›®
        function addReadingSubQuestion() {
            const subtype = document.getElementById('reading-sub-type').value;
            const content = document.getElementById('reading-sub-content').value.trim();
            const optionsText = document.getElementById('reading-sub-options').value.trim();
            const explanation = document.getElementById('reading-sub-explanation').value.trim();
            const score = parseInt(document.getElementById('reading-sub-score').value);
            
            if (!content) {
                alert('è¯·è¾“å…¥å°é¢˜å†…å®¹');
                return;
            }
            
            // è·å–ç­”æ¡ˆ
            let answer = '';
            if (subtype === 'choice') {
                answer = document.getElementById('reading-sub-answer-select').value;
            } else {
                answer = document.getElementById('reading-sub-answer-input').value.trim();
            }
            
            if (!answer) {
                alert('è¯·é€‰æ‹©æˆ–è¾“å…¥æ­£ç¡®ç­”æ¡ˆ');
                return;
            }
            
            let options = [];
            if (subtype === 'choice') {
                options = optionsText.split('\n').filter(o => o.trim()).map(o => o.trim());
                if (options.length < 2) {
                    alert('é€‰æ‹©é¢˜è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹');
                    return;
                }
            }
            
            const subQuestion = {
                type: subtype,
                content: content,
                options: options,
                answer: answer,
                explanation: explanation || 'æš‚æ— è§£æ',
                knowledgePoint: 'é˜…è¯»ç†è§£',
                score: score,
                subQuestionNumber: currentReadingQuestions.length + 1,
                needsGrading: subtype === 'shortanswer'
            };
            
            currentReadingQuestions.push(subQuestion);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('reading-sub-content').value = '';
            document.getElementById('reading-sub-options').value = '';
            document.getElementById('reading-sub-answer-select').value = '';
            document.getElementById('reading-sub-answer-input').value = '';
            document.getElementById('reading-sub-explanation').value = '';
            document.getElementById('reading-sub-score').value = '5';
            
            // æ›´æ–°æ˜¾ç¤º
            updateReadingSubQuestionsList();
            updateReadingSubQuestionNumber();
            
            alert(`âœ… ç¬¬${currentReadingQuestions.length}å°é¢˜æ·»åŠ æˆåŠŸï¼å¯ä»¥ç»§ç»­æ·»åŠ ä¸‹ä¸€é“å°é¢˜`);
        }
        
        // å®Œæˆé˜…è¯»ç†è§£é¢˜
        function finishReadingQuestion() {
            if (currentReadingQuestions.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€é“å°é¢˜');
                return;
            }
            
            const totalScore = currentReadingQuestions.reduce((sum, q) => sum + q.score, 0);
            const needsGradingCount = currentReadingQuestions.filter(q => q.needsGrading).length;
            
            // ç”Ÿæˆæ ¼å¼åŒ–çš„é¢˜ç›®å†…å®¹ï¼Œæ¯é“å°é¢˜å•ç‹¬ä¸€è¡Œå¹¶åŠ ç²—
            const formattedQuestions = currentReadingQuestions.map((q, i) => {
                const questionText = q.content.replace(/\n/g, ' '); // å°†é¢˜ç›®å†…å®¹ä¸­çš„æ¢è¡Œæ›¿æ¢ä¸ºç©ºæ ¼
                return `<strong>ç¬¬${i + 1}é¢˜.</strong> ${questionText}`;
            }).join('<br><br>');
            
            const question = {
                type: 'reading',
                content: `<strong>ã€é˜…è¯»ç†è§£ã€‘</strong><br><br>${currentReadingArticle.replace(/\n/g, '<br>')}<br><br>${formattedQuestions}`,
                article: currentReadingArticle,
                subQuestions: currentReadingQuestions,
                options: [],
                answer: currentReadingQuestions.map((q, i) => `ç¬¬${i + 1}é¢˜ï¼š${q.answer}`).join('\n'),
                explanation: currentReadingQuestions.map((q, i) => `ç¬¬${i + 1}é¢˜ï¼š${q.explanation}`).join('\n'),
                knowledgePoint: 'é˜…è¯»ç†è§£',
                score: totalScore,
                question_order: paperQuestions.length + 1,
                needsGrading: needsGradingCount > 0,
                needsGradingCount: needsGradingCount
            };
            
            paperQuestions.push(question);
            
            // é‡ç½®
            currentReadingArticle = '';
            currentReadingQuestions = [];
            
            updateQuestionsPreview();
            clearQuestionInputs();
            
            const gradingInfo = needsGradingCount > 0 ? `ï¼ˆå…¶ä¸­ ${needsGradingCount} é“ç®€ç­”é¢˜éœ€è¦äººå·¥æ‰¹æ”¹ï¼‰` : '';
            alert(`âœ… é˜…è¯»ç†è§£é¢˜æ·»åŠ æˆåŠŸï¼å…±åŒ…å« ${question.subQuestions.length} é“å°é¢˜${gradingInfo}`);
        }
        
        // å–æ¶ˆé˜…è¯»ç†è§£é¢˜
        function cancelReadingQuestion() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆè¿™é“é˜…è¯»ç†è§£é¢˜å—ï¼Ÿå·²æ·»åŠ çš„å°é¢˜å°†ä¸ä¼šä¿å­˜ã€‚')) {
                currentReadingArticle = '';
                currentReadingQuestions = [];
                updateQuestionsPreview();
                clearQuestionInputs();
            }
        }

        // æ›´æ–°å·²æ·»åŠ é¢˜ç›®é¢„è§ˆ
        function updateQuestionsPreview() {
            const previewDiv = document.getElementById('added-questions-preview');
            if (paperQuestions.length === 0) {
                previewDiv.innerHTML = '<div class="card"><p>è¿˜æœªæ·»åŠ ä»»ä½•é¢˜ç›®</p></div>';
                return;
            }

            const totalScore = paperQuestions.reduce((sum, q) => sum + q.score, 0);
            
            previewDiv.innerHTML = `
                <div class="card">
                    <h3>å·²æ·»åŠ  ${paperQuestions.length} é“é¢˜ç›®ï¼ˆæ€»åˆ†ï¼š${totalScore}åˆ†ï¼‰</h3>
                    ${paperQuestions.map((q, i) => {
                        // è·å–é¢˜å‹åç§°
                        const typeNames = {
                            'choice': 'é€‰æ‹©é¢˜',
                            'fillblank': 'å¡«ç©ºé¢˜',
                            'truefalse': 'åˆ¤æ–­é¢˜',
                            'subjective': 'ä¸»è§‚é¢˜',
                            'reading': 'ğŸ“– é˜…è¯»ç†è§£'
                        };
                        const typeName = typeNames[q.type] || 'é¢˜ç›®';
                        
                        // å¤„ç†å†…å®¹æ˜¾ç¤º
                        let contentPreview = '';
                        if (q.type === 'reading') {
                            // é˜…è¯»ç†è§£é¢˜æ˜¾ç¤º HTML å†…å®¹
                            contentPreview = q.content;
                        } else {
                            // æ™®é€šé¢˜ç›®æˆªå–å‰100å­—ç¬¦
                            contentPreview = q.content.substring(0, 100) + (q.content.length > 100 ? '...' : '');
                        }
                        
                        return `
                        <div class="question-item" style="margin-bottom: 12px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 8px;">
                                ç¬¬${i + 1}é¢˜ [${typeName}] ${q.score}åˆ†
                                <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px; margin-left: 8px;" onclick="removeQuestion(${i})">åˆ é™¤</button>
                            </div>
                            <div style="margin-bottom: 8px;">${contentPreview}</div>
                            <div style="color: #666; font-size: 14px;">ç­”æ¡ˆï¼š${q.answer}</div>
                        </div>
                    `;
                    }).join('')}
                </div>
            `;
        }

        // åˆ é™¤é¢˜ç›®
        function removeQuestion(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™é“é¢˜å—ï¼Ÿ')) {
                paperQuestions.splice(index, 1);
                // é‡æ–°æ’åº
                paperQuestions.forEach((q, i) => q.question_order = i + 1);
                updateQuestionsPreview();
            }
        }

        // å®Œæˆæ·»åŠ ï¼Œä¿å­˜è¯•å·åˆ°æœåŠ¡å™¨
        async function finishAddingQuestions() {
            if (paperQuestions.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€é“é¢˜ç›®');
                return;
            }

            if (!confirm(`ç¡®å®šè¦ä¿å­˜è¿™ä»½è¯•å·å—ï¼Ÿ\nå…±${paperQuestions.length}é“é¢˜ç›®`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/papers/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paper: currentAddingPaper,
                        questions: paperQuestions
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('âœ… è¯•å·æ·»åŠ æˆåŠŸï¼');
                    currentAddingPaper = null;
                    paperQuestions = [];
                    showPaperLibrary();
                } else {
                    alert('æ·»åŠ å¤±è´¥ï¼š' + data.error);
                }
            } catch (error) {
                console.error('æ·»åŠ è¯•å·å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // åŠ è½½è¯•å·åˆ—è¡¨
        async function loadPaperLibrary() {
            try {
                const response = await fetch(`${API_URL}/papers`);
                const papers = await response.json();
                
                const listDiv = document.getElementById('paper-list');
                if (papers.length === 0) {
                    listDiv.innerHTML = '<div class="card"><p>æš‚æ— è¯•å·</p></div>';
                    return;
                }
                
                listDiv.innerHTML = papers.map(paper => `
                    <div class="exam-item">
                        <h3>${paper.title}</h3>
                        <p>
                            <span style="background: #1890ff; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${paper.subject}</span>
                            <span style="background: #52c41a; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">${paper.year}å¹´</span>
                            <span style="background: #faad14; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">${paper.exam_type}</span>
                        </p>
                        <p>é¢˜ç›®æ•°ï¼š${paper.question_count} | æ€»åˆ†ï¼š${paper.total_score} | æ¥æºï¼š${paper.source}</p>
                        <button class="btn btn-success" onclick="importPaperToExam('${paper.id}')">å¯¼å…¥ä¸ºè€ƒè¯•</button>
                        <button class="btn btn-info" onclick="viewPaperDetail('${paper.id}')" style="margin-left: 8px;">æŸ¥çœ‹å†…å®¹</button>
                        <button class="btn" onclick="editPaper('${paper.id}')" style="margin-left: 8px; background: #722ed1; color: white;">ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deletePaper('${paper.id}')" style="margin-left: 8px;">åˆ é™¤</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½è¯•å·åº“å¤±è´¥:', error);
                document.getElementById('paper-list').innerHTML = '<div class="card"><p>åŠ è½½å¤±è´¥</p></div>';
            }
        }

        // å¯¼å…¥è¯•å·ä¸ºè€ƒè¯•
        async function importPaperToExam(paperId) {
            try {
                const response = await fetch(`${API_URL}/papers/${paperId}/import-to-exam`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('âœ… è¯•å·å·²å¯¼å…¥ä¸ºè€ƒè¯•ï¼');
                    showTeacherPanel();
                } else {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + data.error);
                }
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                alert('å¯¼å…¥å¤±è´¥');
            }
        }

        // æŸ¥çœ‹è¯•å·è¯¦æƒ…
        async function viewPaperDetail(paperId) {
            try {
                const response = await fetch(`${API_URL}/papers/${paperId}`);
                const paper = await response.json();
                
                if (!paper || !paper.questions) {
                    alert('è¯•å·ä¸å­˜åœ¨æˆ–æ²¡æœ‰é¢˜ç›®');
                    return;
                }
                
                // ç”Ÿæˆé¢˜ç›®åˆ—è¡¨HTML
                let questionsHtml = '';
                if (paper.questions.length === 0) {
                    questionsHtml = '<p style="color: #999;">æš‚æ— é¢˜ç›®</p>';
                } else {
                    questionsHtml = paper.questions.map((q, index) => {
                        let content = q.content;
                        // å¤„ç†é˜…è¯»ç†è§£é¢˜
                        if (q.type === 'reading' && q.article) {
                            content = `<strong>ã€é˜…è¯»ç†è§£ã€‘</strong><br>${q.article.substring(0, 200)}${q.article.length > 200 ? '...' : ''}`;
                        }
                        
                        return `
                            <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                                <strong>ç¬¬${index + 1}é¢˜</strong> [${q.type === 'choice' ? 'é€‰æ‹©é¢˜' : q.type === 'fillblank' ? 'å¡«ç©ºé¢˜' : q.type === 'truefalse' ? 'åˆ¤æ–­é¢˜' : q.type === 'reading' ? 'ğŸ“– é˜…è¯»ç†è§£' : 'ä¸»è§‚é¢˜'}] ${q.score}åˆ†
                                <p style="margin: 8px 0;">${content}</p>
                                ${q.options && q.options.length > 0 ? `<p style="color: #666; font-size: 14px;">é€‰é¡¹ï¼š${q.options.join(' ')}</p>` : ''}
                                <p style="color: #1890ff; font-size: 14px;">ç­”æ¡ˆï¼š${q.answer || 'æš‚æ— '}</p>
                            </div>
                        `;
                    }).join('');
                }
                
                // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºè¯•å·å†…å®¹
                const modalHtml = `
                    <div id="paper-detail-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
                        <div style="background: white; width: 90%; max-width: 800px; max-height: 80%; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;">
                            <div style="padding: 20px; border-bottom: 1px solid #e8e8e8; display: flex; justify-content: space-between; align-items: center;">
                                <h2 style="margin: 0;">ğŸ“„ ${paper.title}</h2>
                                <button onclick="closePaperDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">Ã—</button>
                            </div>
                            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                                <p style="margin-bottom: 16px; color: #666;">
                                    ç§‘ç›®ï¼š${paper.subject} | å¹´çº§ï¼š${paper.grade || '-'} | å¹´ä»½ï¼š${paper.year || '-'}<br>
                                    é¢˜ç›®æ•°ï¼š${paper.questions.length} | æ€»åˆ†ï¼š${paper.total_score || '-'}åˆ†
                                </p>
                                <h3 style="margin-bottom: 16px;">é¢˜ç›®åˆ—è¡¨</h3>
                                ${questionsHtml}
                            </div>
                            <div style="padding: 20px; border-top: 1px solid #e8e8e8; text-align: right;">
                                <button class="btn" onclick="closePaperDetailModal()">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                const modalDiv = document.createElement('div');
                modalDiv.innerHTML = modalHtml;
                document.body.appendChild(modalDiv);
            } catch (error) {
                console.error('æŸ¥çœ‹è¯•å·è¯¦æƒ…å¤±è´¥:', error);
                alert('æŸ¥çœ‹è¯•å·è¯¦æƒ…å¤±è´¥');
            }
        }
        
        // å…³é—­è¯•å·è¯¦æƒ…æ¨¡æ€æ¡†
        function closePaperDetailModal() {
            const modal = document.getElementById('paper-detail-modal');
            if (modal) {
                modal.remove();
            }
        }

        // åˆ é™¤è¯•å·
        async function deletePaper(paperId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä»½è¯•å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/papers/${paperId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('âœ… è¯•å·å·²åˆ é™¤ï¼');
                    loadPaperLibrary(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // å½“å‰ç¼–è¾‘çš„è¯•å·æ•°æ®
        let currentEditingPaper = null;
        let currentEditingQuestions = [];
        let currentEditReadingArticle = '';
        let currentEditReadingSubQuestions = [];

        // ç¼–è¾‘è¯•å·
        async function editPaper(paperId) {
            try {
                // è·å–è¯•å·è¯¦æƒ…
                const response = await fetch(`${API_URL}/papers/${paperId}`);
                const paper = await response.json();
                
                if (!paper || !paper.id) {
                    alert('è¯•å·ä¸å­˜åœ¨');
                    return;
                }
                
                currentEditingPaper = paper;
                currentEditingQuestions = paper.questions || [];
                
                // å¡«å……è¯•å·ä¿¡æ¯
                document.getElementById('edit-paper-id').value = paper.id;
                document.getElementById('edit-paper-title').value = paper.title || '';
                document.getElementById('edit-paper-exam-type').value = paper.exam_type || 'æœŸæœ«è”è€ƒ';
                document.getElementById('edit-paper-province').value = paper.province || '';
                document.getElementById('edit-paper-subject').value = paper.subject || 'æ•°å­¦';
                document.getElementById('edit-paper-year').value = paper.year || 2024;
                document.getElementById('edit-paper-grade').value = paper.grade || 'é«˜ä¸€';
                document.getElementById('edit-paper-time').value = paper.exam_time || 120;
                
                // æ˜¾ç¤ºé¢˜ç›®åˆ—è¡¨
                updateEditQuestionsList();
                
                // æ¸…ç©ºæ–°é¢˜ç›®è¾“å…¥
                clearEditQuestionInputs();
                
                // æ˜¾ç¤ºç¼–è¾‘é¢æ¿
                hideAll();
                document.getElementById('edit-paper-panel').classList.remove('hidden');
                
            } catch (error) {
                console.error('åŠ è½½è¯•å·å¤±è´¥:', error);
                alert('åŠ è½½è¯•å·å¤±è´¥');
            }
        }

        // æ›´æ–°ç¼–è¾‘ç•Œé¢çš„é¢˜ç›®åˆ—è¡¨
        function updateEditQuestionsList() {
            const listDiv = document.getElementById('edit-questions-list');
            if (currentEditingQuestions.length === 0) {
                listDiv.innerHTML = '<div class="card"><p>æš‚æ— é¢˜ç›®</p></div>';
                return;
            }
            
            const totalScore = currentEditingQuestions.reduce((sum, q) => sum + (q.score || 5), 0);
            
            listDiv.innerHTML = `
                <div class="card">
                    <p style="margin-bottom: 12px;"><strong>å…± ${currentEditingQuestions.length} é“é¢˜ç›®ï¼Œæ€»åˆ† ${totalScore} åˆ†</strong></p>
                    ${currentEditingQuestions.map((q, i) => {
                        // è·å–é¢˜å‹åç§°
                        const typeNames = {
                            'choice': 'é€‰æ‹©é¢˜',
                            'fillblank': 'å¡«ç©ºé¢˜',
                            'truefalse': 'åˆ¤æ–­é¢˜',
                            'subjective': 'ä¸»è§‚é¢˜',
                            'reading': 'ğŸ“– é˜…è¯»ç†è§£é¢˜'
                        };
                        const typeName = typeNames[q.type] || 'é¢˜ç›®';
                        
                        // å¤„ç†å†…å®¹æ˜¾ç¤º
                        let contentPreview = '';
                        if (q.type === 'reading') {
                            // é˜…è¯»ç†è§£é¢˜æ˜¾ç¤ºæ–‡ç« é¢„è§ˆå’Œå°é¢˜æ•°é‡
                            const articlePreview = q.article ? q.article.substring(0, 80) + '...' : '';
                            const subQuestionCount = q.subQuestions ? q.subQuestions.length : 0;
                            contentPreview = `<div style="background: #f6ffed; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                                <strong>ğŸ“„ æ–‡ç« ï¼š</strong>${articlePreview}<br>
                                <strong>ğŸ“ å°é¢˜æ•°é‡ï¼š</strong>${subQuestionCount}é“
                            </div>`;
                        } else {
                            // æ™®é€šé¢˜ç›®æˆªå–å‰100å­—ç¬¦
                            contentPreview = `<div style="margin-bottom: 8px;">${q.content.substring(0, 100)}${q.content.length > 100 ? '...' : ''}</div>`;
                        }
                        
                        return `
                        <div class="question-item" style="margin-bottom: 12px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                            <div style="font-weight: bold; margin-bottom: 8px;">
                                ç¬¬${i + 1}é¢˜ [${typeName}] ${q.score || 5}åˆ†
                                <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px; margin-left: 8px;" onclick="removeEditQuestion(${i})">åˆ é™¤</button>
                            </div>
                            ${contentPreview}
                            <div style="color: #1890ff; font-size: 14px;">ç­”æ¡ˆï¼š${q.answer || 'å¾…è¡¥å……'}</div>
                        </div>
                    `;
                    }).join('')}
                </div>
            `;
        }

        // åˆ é™¤ç¼–è¾‘ä¸­çš„é¢˜ç›®
        function removeEditQuestion(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™é“é¢˜å—ï¼Ÿ')) {
                currentEditingQuestions.splice(index, 1);
                // é‡æ–°æ’åº
                currentEditingQuestions.forEach((q, i) => q.question_order = i + 1);
                updateEditQuestionsList();
            }
        }

        // åˆ‡æ¢ç¼–è¾‘ç•Œé¢çš„ç­”æ¡ˆè¾“å…¥æ–¹å¼
        function toggleEditQuestionOptions() {
            const type = document.getElementById('edit-question-type').value;
            const normalSection = document.getElementById('edit-normal-question-section');
            const readingSection = document.getElementById('edit-reading-section');
            
            if (type === 'reading') {
                // æ˜¾ç¤ºé˜…è¯»ç†è§£é¢˜ä¸“ç”¨åŒºåŸŸ
                normalSection.style.display = 'none';
                readingSection.style.display = 'block';
                // é‡ç½®é˜…è¯»ç†è§£é¢˜çŠ¶æ€
                document.getElementById('edit-reading-step1').style.display = 'block';
                document.getElementById('edit-reading-step2').style.display = 'none';
                document.getElementById('edit-reading-article').value = '';
                currentEditReadingArticle = '';
                currentEditReadingSubQuestions = [];
                updateEditReadingSubQuestionsList();
            } else {
                // æ˜¾ç¤ºæ™®é€šé¢˜ç›®åŒºåŸŸ
                normalSection.style.display = 'block';
                readingSection.style.display = 'none';
                
                // åˆ‡æ¢æ™®é€šé¢˜ç›®çš„é€‰é¡¹æ˜¾ç¤º
                const choiceDiv = document.getElementById('edit-choice-options-div');
                const answerChoice = document.getElementById('edit-answer-choice');
                const answerTrueFalse = document.getElementById('edit-answer-truefalse');
                const answerText = document.getElementById('edit-answer-text');
                
                // éšè—æ‰€æœ‰
                choiceDiv.style.display = 'none';
                answerChoice.style.display = 'none';
                answerTrueFalse.style.display = 'none';
                answerText.style.display = 'none';
                
                if (type === 'choice') {
                    choiceDiv.style.display = 'block';
                    answerChoice.style.display = 'block';
                } else if (type === 'truefalse') {
                    answerTrueFalse.style.display = 'block';
                } else {
                    answerText.style.display = 'block';
                }
            }
        }

        // æ¸…ç©ºç¼–è¾‘ç•Œé¢çš„é¢˜ç›®è¾“å…¥
        function clearEditQuestionInputs() {
            document.getElementById('edit-question-content').value = '';
            document.getElementById('edit-question-options').value = '';
            document.getElementById('edit-question-answer-choice').value = '';
            document.getElementById('edit-question-answer-truefalse').value = '';
            document.getElementById('edit-question-answer-text').value = '';
            document.getElementById('edit-question-explanation').value = '';
            document.getElementById('edit-question-knowledge').value = '';
            document.getElementById('edit-question-score').value = '5';
            document.getElementById('edit-question-type').value = 'choice';
            toggleEditQuestionOptions();
        }

        // ==================== ç¼–è¾‘è¯•å·æ—¶é˜…è¯»ç†è§£é¢˜ç›¸å…³å‡½æ•° ====================
        
        // ç¡®è®¤é˜…è¯»æ–‡ç« ï¼Œè¿›å…¥æ·»åŠ å°é¢˜æ­¥éª¤
        function confirmEditReadingArticle() {
            const article = document.getElementById('edit-reading-article').value.trim();
            if (!article) {
                alert('è¯·è¾“å…¥é˜…è¯»æ–‡ç« ');
                return;
            }
            
            currentEditReadingArticle = article;
            document.getElementById('edit-reading-step1').style.display = 'none';
            document.getElementById('edit-reading-step2').style.display = 'block';
            document.getElementById('edit-reading-article-preview').textContent = article.substring(0, 300) + (article.length > 300 ? '...' : '');
            updateEditReadingSubQuestionsList();
        }
        
        // åˆ‡æ¢å­é¢˜ç›®é€‰é¡¹æ˜¾ç¤º
        function toggleEditReadingSubOptions() {
            const type = document.getElementById('edit-reading-sub-type').value;
            const optionsDiv = document.getElementById('edit-reading-sub-options-div');
            const answerChoice = document.getElementById('edit-reading-sub-answer-choice');
            const answerText = document.getElementById('edit-reading-sub-answer-text');
            
            if (type === 'choice') {
                optionsDiv.style.display = 'block';
                answerChoice.style.display = 'block';
                answerText.style.display = 'none';
            } else {
                optionsDiv.style.display = 'none';
                answerChoice.style.display = 'none';
                answerText.style.display = 'block';
            }
        }
        
        // æ·»åŠ å­é¢˜ç›®
        function addEditReadingSubQuestion() {
            const type = document.getElementById('edit-reading-sub-type').value;
            const content = document.getElementById('edit-reading-sub-content').value.trim();
            const explanation = document.getElementById('edit-reading-sub-explanation').value.trim();
            const score = parseInt(document.getElementById('edit-reading-sub-score').value) || 5;
            
            if (!content) {
                alert('è¯·è¾“å…¥å°é¢˜å†…å®¹');
                return;
            }
            
            let answer = '';
            let options = [];
            
            if (type === 'choice') {
                const optionsText = document.getElementById('edit-reading-sub-options').value.trim();
                if (!optionsText) {
                    alert('è¯·è¾“å…¥é€‰é¡¹');
                    return;
                }
                options = optionsText.split('\n').filter(opt => opt.trim());
                answer = document.getElementById('edit-reading-sub-answer-select').value;
                if (!answer) {
                    alert('è¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ');
                    return;
                }
            } else {
                answer = document.getElementById('edit-reading-sub-answer-input').value.trim();
                if (!answer) {
                    alert('è¯·è¾“å…¥å‚è€ƒç­”æ¡ˆ');
                    return;
                }
            }
            
            currentEditReadingSubQuestions.push({
                type,
                content,
                options,
                answer,
                explanation,
                score,
                subQuestionNumber: currentEditReadingSubQuestions.length + 1
            });
            
            // æ¸…ç©ºè¾“å…¥
            document.getElementById('edit-reading-sub-content').value = '';
            document.getElementById('edit-reading-sub-options').value = '';
            document.getElementById('edit-reading-sub-answer-select').value = '';
            document.getElementById('edit-reading-sub-answer-input').value = '';
            document.getElementById('edit-reading-sub-explanation').value = '';
            document.getElementById('edit-reading-sub-score').value = '5';
            document.getElementById('edit-reading-sub-type').value = 'choice';
            toggleEditReadingSubOptions();
            
            updateEditReadingSubQuestionsList();
        }
        
        // æ›´æ–°å­é¢˜ç›®åˆ—è¡¨æ˜¾ç¤º
        function updateEditReadingSubQuestionsList() {
            const listDiv = document.getElementById('edit-reading-subquestions-list');
            const numberSpan = document.getElementById('edit-reading-subquestion-number');
            
            numberSpan.textContent = currentEditReadingSubQuestions.length + 1;
            
            if (currentEditReadingSubQuestions.length === 0) {
                listDiv.innerHTML = '<p style="color: #999;">è¿˜æœªæ·»åŠ å°é¢˜</p>';
                return;
            }
            
            const totalScore = currentEditReadingSubQuestions.reduce((sum, q) => sum + q.score, 0);
            
            listDiv.innerHTML = `
                <div class="card" style="background: #f6ffed; margin-bottom: 12px;">
                    <p style="margin-bottom: 8px;"><strong>å·²æ·»åŠ  ${currentEditReadingSubQuestions.length} é“å°é¢˜ï¼Œå…± ${totalScore} åˆ†</strong></p>
                    ${currentEditReadingSubQuestions.map((q, i) => `
                        <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                            <strong>ç¬¬${i + 1}å°é¢˜</strong> [${q.type === 'choice' ? 'é€‰æ‹©é¢˜' : 'ç®€ç­”é¢˜'}] ${q.score}åˆ†
                            <button class="btn btn-danger" style="padding: 2px 6px; font-size: 12px; margin-left: 8px;" onclick="removeEditReadingSubQuestion(${i})">åˆ é™¤</button>
                            <p style="margin: 4px 0;">${q.content.substring(0, 50)}${q.content.length > 50 ? '...' : ''}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // åˆ é™¤å­é¢˜ç›®
        function removeEditReadingSubQuestion(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™é“å°é¢˜å—ï¼Ÿ')) {
                currentEditReadingSubQuestions.splice(index, 1);
                // é‡æ–°ç¼–å·
                currentEditReadingSubQuestions.forEach((q, i) => q.subQuestionNumber = i + 1);
                updateEditReadingSubQuestionsList();
            }
        }
        
        // å®Œæˆé˜…è¯»ç†è§£é¢˜
        function finishEditReadingQuestion() {
            if (currentEditReadingSubQuestions.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€é“å°é¢˜');
                return;
            }
            
            const totalScore = currentEditReadingSubQuestions.reduce((sum, q) => sum + q.score, 0);
            
            // ç”Ÿæˆæ ¼å¼åŒ–çš„é¢˜ç›®å†…å®¹
            const formattedQuestions = currentEditReadingSubQuestions.map((q, i) => {
                const questionText = q.content.replace(/\n/g, ' ');
                return `<strong>ç¬¬${i + 1}é¢˜.</strong> ${questionText}`;
            }).join('<br><br>');
            
            const question = {
                type: 'reading',
                content: `<strong>ã€é˜…è¯»ç†è§£ã€‘</strong><br><br>${currentEditReadingArticle.replace(/\n/g, '<br>')}<br><br>${formattedQuestions}`,
                article: currentEditReadingArticle,
                subQuestions: currentEditReadingSubQuestions,
                options: [],
                answer: currentEditReadingSubQuestions.map((q, i) => `ç¬¬${i + 1}é¢˜ï¼š${q.answer}`).join('\n'),
                explanation: currentEditReadingSubQuestions.map((q, i) => `ç¬¬${i + 1}é¢˜ï¼š${q.explanation}`).join('\n'),
                knowledgePoint: 'é˜…è¯»ç†è§£',
                score: totalScore,
                question_order: currentEditingQuestions.length + 1
            };
            
            currentEditingQuestions.push(question);
            
            // é‡ç½®
            currentEditReadingArticle = '';
            currentEditReadingSubQuestions = [];
            document.getElementById('edit-reading-article').value = '';
            document.getElementById('edit-reading-step1').style.display = 'block';
            document.getElementById('edit-reading-step2').style.display = 'none';
            
            updateEditQuestionsList();
            updateEditReadingSubQuestionsList();
            
            // åˆ‡æ¢å›æ™®é€šé¢˜ç›®ç±»å‹
            document.getElementById('edit-question-type').value = 'choice';
            toggleEditQuestionOptions();
            
            alert('âœ… é˜…è¯»ç†è§£é¢˜æ·»åŠ æˆåŠŸï¼');
        }
        
        // å–æ¶ˆé˜…è¯»ç†è§£é¢˜
        function cancelEditReadingQuestion() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆå—ï¼Ÿå·²æ·»åŠ çš„å°é¢˜å°†ä¸ä¼šä¿å­˜ã€‚')) {
                currentEditReadingArticle = '';
                currentEditReadingSubQuestions = [];
                document.getElementById('edit-reading-article').value = '';
                document.getElementById('edit-reading-step1').style.display = 'block';
                document.getElementById('edit-reading-step2').style.display = 'none';
                updateEditReadingSubQuestionsList();
                
                // åˆ‡æ¢å›æ™®é€šé¢˜ç›®ç±»å‹
                document.getElementById('edit-question-type').value = 'choice';
                toggleEditQuestionOptions();
            }
        }

        // æ·»åŠ é¢˜ç›®åˆ°æ­£åœ¨ç¼–è¾‘çš„è¯•å·
        function addQuestionToExistingPaper() {
            const type = document.getElementById('edit-question-type').value;
            const content = document.getElementById('edit-question-content').value.trim();
            const optionsText = document.getElementById('edit-question-options').value.trim();
            const explanation = document.getElementById('edit-question-explanation').value.trim();
            const knowledge = document.getElementById('edit-question-knowledge').value.trim();
            const score = parseInt(document.getElementById('edit-question-score').value);
            
            // æ ¹æ®ç±»å‹è·å–ç­”æ¡ˆ
            let answer = '';
            if (type === 'choice') {
                answer = document.getElementById('edit-question-answer-choice').value;
            } else if (type === 'truefalse') {
                answer = document.getElementById('edit-question-answer-truefalse').value;
            } else {
                answer = document.getElementById('edit-question-answer-text').value.trim();
            }
            
            if (!content) {
                alert('è¯·è¾“å…¥é¢˜ç›®å†…å®¹');
                return;
            }
            if (!answer) {
                alert('è¯·é€‰æ‹©æˆ–è¾“å…¥æ­£ç¡®ç­”æ¡ˆ');
                return;
            }
            
            let options = [];
            if (type === 'choice') {
                options = optionsText.split('\n').filter(o => o.trim()).map(o => o.trim());
                if (options.length < 2) {
                    alert('é€‰æ‹©é¢˜è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹');
                    return;
                }
            } else if (type === 'truefalse') {
                options = ['æ­£ç¡®', 'é”™è¯¯'];
            }
            
            const question = {
                type,
                content,
                options,
                answer,
                explanation: explanation || 'æš‚æ— è§£æ',
                knowledgePoint: knowledge || 'ç»¼åˆçŸ¥è¯†',
                score,
                question_order: currentEditingQuestions.length + 1
            };
            
            currentEditingQuestions.push(question);
            updateEditQuestionsList();
            clearEditQuestionInputs();
            
            alert(`âœ… ç¬¬${currentEditingQuestions.length}é¢˜æ·»åŠ æˆåŠŸï¼`);
        }

        // ä¿å­˜è¯•å·ä¿®æ”¹
        async function savePaperChanges() {
            if (currentEditingQuestions.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€é“é¢˜ç›®');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦ä¿å­˜ä¿®æ”¹å—ï¼Ÿ')) {
                return;
            }
            
            const paperId = document.getElementById('edit-paper-id').value;
            const paperInfo = {
                title: document.getElementById('edit-paper-title').value.trim(),
                examType: document.getElementById('edit-paper-exam-type').value,
                province: document.getElementById('edit-paper-province').value.trim() || 'æœªçŸ¥',
                subject: document.getElementById('edit-paper-subject').value,
                year: parseInt(document.getElementById('edit-paper-year').value),
                grade: document.getElementById('edit-paper-grade').value,
                examTime: parseInt(document.getElementById('edit-paper-time').value)
            };
            
            if (!paperInfo.title) {
                alert('è¯·è¾“å…¥è¯•å·æ ‡é¢˜');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/papers/${paperId}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paperInfo,
                        questions: currentEditingQuestions
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('âœ… è¯•å·ä¿®æ”¹å·²ä¿å­˜ï¼');
                    showPaperLibrary();
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        async function startTakingExam(examId) {
            try {
                const response = await fetch(`${API_URL}/exams/${examId}`);
                const exam = await response.json();
                
                console.log('è€ƒè¯•æ•°æ®:', exam);
                console.log('é¢˜ç›®åˆ—è¡¨:', exam.questions);
                
                if (!exam.questions || exam.questions.length === 0) {
                    alert('è€ƒè¯•æ²¡æœ‰é¢˜ç›®ï¼Œè¯·è”ç³»æ•™å¸ˆæ·»åŠ é¢˜ç›®');
                    return;
                }
                
                currentExam = exam;
                currentQuestions = exam.questions;
                currentAnswers = {};
                currentQuestionIndex = 0;
                timeLeft = exam.time_limit * 60;
                
                hideAll();
                document.getElementById('exam-page').classList.remove('hidden');
                document.getElementById('exam-title-display').textContent = exam.title;
                
                startTimer();
                renderQuestionNav();
                renderQuestion();
                updateProgress();
            } catch (error) {
                console.error('åŠ è½½è€ƒè¯•å¤±è´¥:', error);
                alert('åŠ è½½è€ƒè¯•å¤±è´¥');
            }
        }

        // è®¡æ—¶å™¨
        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const mins = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const secs = (timeLeft % 60).toString().padStart(2, '0');
            const timerEl = document.getElementById('timer');
            timerEl.textContent = `${mins}:${secs}`;
            if (timeLeft < 300) timerEl.classList.add('warning');
        }

        // æ¸²æŸ“é¢˜ç›®å¯¼èˆª
        function renderQuestionNav() {
            const navDiv = document.getElementById('question-nav');
            navDiv.innerHTML = currentQuestions.map((q, i) => `
                <button class="nav-btn ${currentAnswers[q.id] ? 'answered' : ''}" onclick="goToQuestion(${i})">${i+1}</button>
            `).join('');
        }

        // æ¸²æŸ“é¢˜ç›®
        function renderQuestion() {
            try {
                const question = currentQuestions[currentQuestionIndex];
                const container = document.getElementById('question-container');
                
                // è°ƒè¯•ä¿¡æ¯
                console.log('æ¸²æŸ“é¢˜ç›®:', question);
                console.log('currentQuestionIndex:', currentQuestionIndex);
                console.log('currentQuestions.length:', currentQuestions.length);
                
                if (!question) {
                    container.innerHTML = '<div class="question-item"><p>é¢˜ç›®åŠ è½½å¤±è´¥ï¼šæ‰¾ä¸åˆ°é¢˜ç›®æ•°æ®</p></div>';
                    return;
                }
                
                const answer = currentAnswers[question.id];
                
                let html = '';
                
                if (question.type === 'reading') {
                    // é˜…è¯»ç†è§£é¢˜ç‰¹æ®Šå¤„ç†
                    html = renderReadingQuestion(question, answer);
                } else {
                    // æ™®é€šé¢˜ç›®
                    html = `<div class="question-item"><h3>ç¬¬${currentQuestionIndex+1}é¢˜</h3><p>${question.content}</p>`;

                    if (question.type === 'choice') {
                        html += question.options.map(opt => {
                            const optLetter = opt.charAt(0);
                            const optText = opt.substring(2);
                            const escapedText = optText.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            return `<div class="option-item ${answer === optLetter ? 'selected' : ''}" onclick="selectAnswer('${question.id}', '${optLetter}')">${optLetter}. ${escapedText}</div>`;
                        }).join('');
                    } else if (question.type === 'truefalse') {
                        html += `
                            <div class="option-item ${answer === 'æ­£ç¡®' ? 'selected' : ''}" onclick="selectAnswer('${question.id}', 'æ­£ç¡®')">æ­£ç¡®</div>
                            <div class="option-item ${answer === 'é”™è¯¯' ? 'selected' : ''}" onclick="selectAnswer('${question.id}', 'é”™è¯¯')">é”™è¯¯</div>
                        `;
                    } else {
                        html += `<input type="text" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" value="${answer || ''}" onchange="selectAnswer('${question.id}', this.value)">`;
                    }

                    html += '</div>';
                }
            
            container.innerHTML = html;
            
            // æ›´æ–°æŒ‰é’®æ–‡å­—
            const nextBtn = document.getElementById('next-btn');
            if (currentQuestionIndex === currentQuestions.length - 1) {
                nextBtn.textContent = 'æäº¤ç­”å·';
                nextBtn.onclick = confirmSubmit;
                nextBtn.classList.add('btn-success');
            } else {
                nextBtn.textContent = 'ä¸‹ä¸€é¢˜';
                nextBtn.onclick = nextQuestion;
                nextBtn.classList.remove('btn-success');
            }
            } catch (error) {
                console.error('æ¸²æŸ“é¢˜ç›®å‡ºé”™:', error);
                document.getElementById('question-container').innerHTML = 
                    '<div class="question-item"><p style="color: red;">é¢˜ç›®æ¸²æŸ“å‡ºé”™ï¼š' + error.message + '</p></div>';
            }
        }

        // æ¸²æŸ“é˜…è¯»ç†è§£é¢˜
        function renderReadingQuestion(question, answer) {
            console.log('æ¸²æŸ“é˜…è¯»ç†è§£é¢˜:', question);
            console.log('article:', question.article);
            console.log('subQuestions:', question.subQuestions);
            
            // ç¡®ä¿ subQuestions æ˜¯æ•°ç»„
            let subQuestions = question.subQuestions;
            if (!Array.isArray(subQuestions)) {
                // å°è¯•è§£æå¦‚æœæ˜¯å­—ç¬¦ä¸²
                if (typeof subQuestions === 'string') {
                    try {
                        subQuestions = JSON.parse(subQuestions);
                    } catch (e) {
                        subQuestions = [];
                    }
                } else {
                    subQuestions = [];
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ–‡ç« å’Œå°é¢˜æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (!question.article && subQuestions.length === 0) {
                return '<div class="question-item"><p style="color: red;">é˜…è¯»ç†è§£é¢˜æ•°æ®ä¸å®Œæ•´ï¼Œè¯·è”ç³»æ•™å¸ˆæ£€æŸ¥é¢˜ç›®</p></div>';
            }
            
            let html = '<div class="question-item">';
            
            // æ˜¾ç¤ºæ–‡ç« 
            if (question.article) {
                html += `<div style="background: #f6ffed; padding: 16px; border-radius: 8px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                    <h4 style="margin-bottom: 12px;">ğŸ“– é˜…è¯»ææ–™</h4>
                    <div style="line-height: 1.8; text-align: justify;">${question.article.replace(/\n/g, '<br>')}</div>
                </div>`;
            }
            
            // æ˜¾ç¤ºå°é¢˜
            if (subQuestions.length > 0) {
                html += '<h4 style="margin-bottom: 16px;">é¢˜ç›®ï¼š</h4>';
                
                subQuestions.forEach((subQ, index) => {
                    const subAnswer = currentAnswers[`${question.id}_sub_${index}`] || '';
                    
                    html += `<div style="margin-bottom: 20px; padding: 16px; background: #f5f5f5; border-radius: 8px; border-left: 4px solid ${subQ.type === 'choice' ? '#1890ff' : '#52c41a'};">`;
                    html += `<div style="font-weight: bold; margin-bottom: 12px;">ç¬¬${index + 1}å°é¢˜ï¼ˆ${subQ.type === 'choice' ? 'é€‰æ‹©é¢˜' : 'ç®€ç­”é¢˜'}ï¼‰${subQ.score}åˆ†</div>`;
                    html += `<div style="margin-bottom: 12px;">${subQ.content}</div>`;
                    
                    if (subQ.type === 'choice' && subQ.options && subQ.options.length > 0) {
                        // é€‰æ‹©é¢˜æ˜¾ç¤ºé€‰é¡¹
                        html += '<div style="margin-left: 16px;">';
                        subQ.options.forEach(opt => {
                            const optLetter = opt.charAt(0);
                            const isSelected = subAnswer === optLetter;
                            html += `<div class="option-item ${isSelected ? 'selected' : ''}" 
                                style="margin: 8px 0; padding: 10px; border: 1px solid ${isSelected ? '#1890ff' : '#d9d9d9'}; border-radius: 4px; cursor: pointer; background: ${isSelected ? '#e6f7ff' : 'white'};"
                                onclick="selectReadingSubAnswer('${question.id}', ${index}, '${optLetter}')">${opt}</div>`;
                        });
                        html += '</div>';
                    } else {
                        // ç®€ç­”é¢˜æ˜¾ç¤ºæ–‡æœ¬è¾“å…¥
                        html += `<textarea placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" rows="4" style="width: 100%; padding: 12px; border: 1px solid #d9d9d9; border-radius: 4px;"
                            onchange="selectReadingSubAnswer('${question.id}', ${index}, this.value)">${subAnswer}</textarea>`;
                    }
                    
                    html += '</div>';
                });
            }
            
            html += '</div>';
            return html;
        }

        // é€‰æ‹©é˜…è¯»ç†è§£å­é¢˜ç›®çš„ç­”æ¡ˆ
        function selectReadingSubAnswer(questionId, subIndex, answer) {
            currentAnswers[`${questionId}_sub_${subIndex}`] = answer;
            renderQuestionNav();
            updateProgress();
            renderQuestion();
        }

        function selectAnswer(questionId, answer) {
            currentAnswers[questionId] = answer;
            renderQuestionNav();
            updateProgress();
            renderQuestion();
        }

        function goToQuestion(index) {
            currentQuestionIndex = index;
            renderQuestion();
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        }

        function updateProgress() {
            // è®¡ç®—å·²å›ç­”çš„é¢˜ç›®æ•°é‡
            let answeredCount = 0;
            const answeredQuestionIds = new Set();
            
            for (const key of Object.keys(currentAnswers)) {
                if (key.includes('_sub_')) {
                    // é˜…è¯»ç†è§£é¢˜çš„å­é¢˜ç›®
                    const questionId = key.split('_')[0];
                    answeredQuestionIds.add(questionId);
                } else {
                    // æ™®é€šé¢˜ç›®
                    answeredQuestionIds.add(key);
                }
            }
            
            answeredCount = answeredQuestionIds.size;
            const total = currentQuestions.length;
            const percent = (answeredCount / total) * 100;
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-text').textContent = `å·²ä½œç­” ${answeredCount}/${total} é¢˜`;
        }

        function confirmSubmit() {
            let answeredCount = 0;
            const answeredQuestionIds = new Set();
            
            for (const key of Object.keys(currentAnswers)) {
                if (key.includes('_sub_')) {
                    const questionId = key.split('_')[0];
                    answeredQuestionIds.add(questionId);
                } else {
                    answeredQuestionIds.add(key);
                }
            }
            answeredCount = answeredQuestionIds.size;
            
            const total = currentQuestions.length;
            if (answeredCount < total) {
                if (!confirm(`è¿˜æœ‰ ${total - answeredCount} é¢˜æœªä½œç­”ï¼Œç¡®è®¤æäº¤ï¼Ÿ`)) return;
            } else {
                if (!confirm('ç¡®è®¤æäº¤ç­”å·ï¼Ÿ')) return;
            }
            submitExam();
        }

        async function submitExam() {
            clearInterval(timerInterval);
            
            try {
                console.log('æäº¤è€ƒè¯•ï¼ŒcurrentAnswers:', currentAnswers);
                console.log('currentExam:', currentExam);
                console.log('studentInfo:', studentInfo);
                
                // å¤„ç†ç­”æ¡ˆï¼Œå°†é˜…è¯»ç†è§£é¢˜çš„å­é¢˜ç›®ç­”æ¡ˆåˆå¹¶
                const processedAnswers = {};
                
                for (const [key, answer] of Object.entries(currentAnswers)) {
                    if (key.includes('_sub_')) {
                        // è¿™æ˜¯é˜…è¯»ç†è§£é¢˜çš„å­é¢˜ç›®ç­”æ¡ˆ
                        const [questionId, , subIndex] = key.split('_');
                        if (!processedAnswers[questionId]) {
                            processedAnswers[questionId] = {};
                        }
                        processedAnswers[questionId][subIndex] = answer;
                    } else {
                        // æ™®é€šé¢˜ç›®ç­”æ¡ˆ
                        processedAnswers[key] = answer;
                    }
                }
                
                console.log('processedAnswers:', processedAnswers);
                
                // å°†é˜…è¯»ç†è§£é¢˜çš„å­ç­”æ¡ˆæ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²
                for (const [questionId, answer] of Object.entries(processedAnswers)) {
                    let finalAnswer = answer;
                    if (typeof answer === 'object') {
                        // æ˜¯é˜…è¯»ç†è§£é¢˜çš„å­ç­”æ¡ˆå¯¹è±¡
                        const subAnswers = [];
                        const indices = Object.keys(answer).sort((a, b) => parseInt(a) - parseInt(b));
                        indices.forEach(idx => {
                            subAnswers.push(`ç¬¬${parseInt(idx) + 1}é¢˜ï¼š${answer[idx]}`);
                        });
                        finalAnswer = subAnswers.join('\n');
                    }
                    
                    console.log('æäº¤ç­”æ¡ˆ:', { questionId, finalAnswer });
                    
                    const response = await fetch(`${API_URL}/exams/${currentExam.id}/submit-answer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            studentName: studentInfo.name,
                            studentId: studentInfo.id,
                            className: studentInfo.className,
                            questionId,
                            answer: finalAnswer
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('æäº¤ç­”æ¡ˆå¤±è´¥:', errorData);
                    }
                }
                
                alert('ç­”æ¡ˆæäº¤æˆåŠŸï¼');
                showStudentPanel();
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥');
            }
        }
    </script>
</body>
</html>
